# ShlapaBank — учебный банковский проект

Учебный проект для практики написания API и UI тестов.

---

## Запуск

**1)** Скачайте проект к себе в удобную папку. На GitHub нажмите зелёную кнопку «Code» и выберите **Download ZIP**. Обязательно распакуйте архив — проект должен лежать в обычной папке, а не в ZIP.

![Скачать проект (Download ZIP)](docs/helpers/download-zip.png)

**2)** Скачайте и установите [Docker](https://www.docker.com/get-started) и зарегистрируйтесь (нужен аккаунт для скачивания образов).

**3)** Поднимите контейнеры из папки проекта. Откройте обычный терминал (CMD или PowerShell), перейдите в папку с распакованным проектом.
Например:

```powershell
cd C:\Users\Имя\Downloads\shlapabank
```

Затем выполните:

```powershell
docker compose up --build
```

Запущенный проект в Docker Desktop выглядит так (контейнеры **shlapabank**, **backend**, **db** в статусе Running):

![Запущенный проект в Docker](docs/helpers/docker-running.png)

После запуска откройте в браузере главную страницу интерфейса банка:

- **Главная страница (UI):** http://localhost:8001/ или http://localhost:8001/login  

---

## Для удобства

**Swagger** — доступен по клику «Swagger» в левом верхнем углу интерфейса.

**Страница входа:** ссылка «Не можете войти?» позволяет очистить кеш браузера при проблемах со входом.

![Swagger](docs/helpers/swagger.png)

**Читерская шляпа:** логотип-шляпа в левом верхнем углу. Клик открывает окно быстрого изменения баланса счетов (пополнение, списание или обнуление) без подтверждения. Пополнение создаёт запись в истории операций и учитывается в статистике. Администратор видит все счета в системе и может начислить зарплату на любой счёт; клиент — только пополнение и подарок на свои счета.

![Helper](docs/helpers/helper-ui.png)

---

## Блок 1. Проверка доступности сервиса (Health)

### Бизнес-требования

Система должна позволять проверить, что банковское приложение доступно и работает. Эта проверка не требует входа в систему.

**Ограничения:** нет; проверка доступна всем.

**Ожидаемое поведение:** при доступности сервиса проверка всегда успешна.

**Способ проверки:** запрос `GET /api/v1/health` (без авторизации) или открытие главной страницы в браузере.

---

## Блок 2. Вспомогательные операции (Helper)

### Бизнес-требования

Специальный режим для подготовки тестовых данных: получение одноразового кода подтверждения и изменение баланса счетов.

- **Получение кода подтверждения:** пользователь может получить одноразовый код из 4 цифр. Код действует 1 минуту. Он нужен для подтверждения пополнения, переводов и платежей.
- **Пополнение баланса:** пользователь может увеличить баланс счёта. Операция создаёт запись в истории и учитывается в статистике. Можно указать тип дохода: пополнение, подарок или зарплата (только для администратора). Администратор может пополнять любой счёт в системе, клиент — только свои.
- **Списание и обнуление:** пользователь может уменьшить или обнулить баланс своего счёта. При списании баланс не может стать отрицательным. Эти операции не создают записей в истории.

**Ограничения:**
- Клиент работает только со своими счетами; администратор — с любыми (для начисления зарплаты).
- С закрытым счётом операции запрещены.
- При списании — проверка достаточности средств.
- Зарплату может начислить только администратор.

**Ошибки (с точки зрения пользователя):**

| Ситуация | Результат |
|----------|-----------|
| Счёт не найден или не принадлежит пользователю | Ошибка «счёт не найден» |
| Счёт закрыт | Ошибка «счёт неактивен» |
| Недостаточно средств при списании | Ошибка «недостаточно средств» |

---

## Блок 3. Администрирование (Admin)

### Бизнес-требования

Администратор управляет пользователями и счетами: просматривает список пользователей, блокирует и разблокирует их, удаляет (для очистки тестовых данных), просматривает и пополняет счета, просматривает транзакции, настраивает банки для перевода по телефону.

- **Пополнение счёта:** администратор указывает сумму (обязательно положительную) и пополняет любой счёт.
- **Банки для перевода по телефону:** у пользователя может быть от 0 до 5 внешних банков. Наш банк в список не включается. Нельзя указать несуществующий банк.

**Ограничения:**
- Доступ только у роли администратор; обычный клиент не может выполнять эти действия.
- Администратора по умолчанию удалить нельзя.
- Максимум 5 банков на пользователя.

**Ошибки (с точки зрения пользователя):**

| Ситуация | Результат |
|----------|-----------|
| Пользователь не найден | Ошибка «не найден» |
| Счёт не найден | Ошибка «счёт не найден» |
| Сумма нулевая или отрицательная | Ошибка «сумма должна быть положительной» |
| Указан наш банк или несуществующий | Ошибка «неверные коды банков» |
| Больше 5 банков | Ошибка «максимум 5 банков» |
| Попытка удалить администратора по умолчанию | Ошибка «нельзя удалить» |

---

## Блок 4. Регистрация и вход (Auth)

### Бизнес-требования

**Регистрация** — создание нового пользователя по логину и паролю.

- **Логин:** 6–20 символов, только латиница (A–Z, a–z) и цифры (0–9); без пробелов, кириллицы и спецсимволов. Логин должен быть уникален в системе.
- **Пароль:** 8–30 символов, минимум 1 строчная буква, 1 заглавная, 1 цифра, 1 спецсимвол, без пробелов, не должен совпадать с логином.

При регистрации пользователю назначается случайный набор 0–5 внешних банков для переводов по телефону.

**Вход** — проверка логина и пароля, выдача доступа к защищённым функциям.

**Ограничения:**
- После 5 неудачных попыток входа подряд пользователь блокируется. Разблокировать может только администратор.
- При успешном входе счётчик неудачных попыток сбрасывается.

**Ошибки (с точки зрения пользователя):**

| Ситуация | Результат |
|----------|-----------|
| Неверный логин или пароль | Ошибка «неверные учётные данные» |
| Пользователь заблокирован | Ошибка «доступ запрещён» |
| Логин уже занят | Ошибка «логин не уникален» |
| Пароль совпадает с логином | Ошибка валидации |
| Пароль не соответствует правилам | Ошибка валидации |
| В пароле есть пробел | Ошибка валидации |
| Некорректный формат данных (длина, символы) | Ошибка валидации с описанием |

---

## Блок 5. Сессия пользователя

### Бизнес-требования

Большинство операций требуют, чтобы пользователь был авторизован. Сессия создаётся при успешном входе.

- **Срок действия сессии:** по умолчанию 60 минут. После истечения нужен повторный вход.
- **Защищённые операции:** все, кроме проверки доступности, регистрации и входа.
- **Истёкшая или недействительная сессия:** доступ к защищённым операциям запрещён.
- **Заблокированный пользователь:** доступ запрещён даже при действующей сессии.

**Ограничения:** без действующей сессии доступ к защищённым операциям запрещён.

**Ошибки (с точки зрения пользователя):**

| Ситуация | Результат |
|----------|-----------|
| Сессия истекла или недействительна | Ошибка «недействительная сессия» |
| Пользователь заблокирован | Ошибка «доступ запрещён» |

---

## Блок 6. Профиль пользователя (Profile)

### Бизнес-требования

Пользователь может просматривать и обновлять свои данные: имя, фамилия, телефон, email, смена пароля.

- **Имя, фамилия:** только буквы (латиница и кириллица), длина 1–100 символов. Необязательно.
- **Телефон:** формат +7 и 10 цифр. Необязательно.
- **Email:** корректный адрес почты. Необязательно.
- **Смена пароля:** обязательно указать текущий и новый пароль. Правила для нового пароля — как при регистрации. Новый пароль не должен совпадать с текущим.

**Ограничения:**
- Телефон и email уникальны в системе; при совпадении с другим пользователем — ошибка.
- Длина имени и фамилии — не более 100 символов.

**Ошибки (с точки зрения пользователя):**

| Ситуация | Результат |
|----------|-----------|
| Телефон уже используется | Ошибка «телефон не уникален» |
| Email уже используется | Ошибка «email не уникален» |
| Указан только текущий или только новый пароль | Ошибка «нужны оба поля» |
| Неверный текущий пароль | Ошибка «неверный текущий пароль» |
| Новый пароль совпадает с текущим | Ошибка «повтор пароля не допускается» |

---

## Блок 7. Счета (Accounts)

### Бизнес-требования

Пользователь управляет своими банковскими счетами: просматривает список активных счетов, создаёт новые, закрывает, пополняет.

- **Создание счёта:** пользователь выбирает тип счёта и валюту.
  - **Расчётный (DEBIT):** с него можно переводить, платить и пополнять.
  - **Накопительный (SAVINGS):** только пополнение и хранение, переводить с него нельзя.
  - **Валюты:** рубли (RUB), доллары (USD), евро (EUR), юани (CNY).
  - Номер счёта выдаётся автоматически.
- **Закрытие счёта:** возможно только при нулевом балансе.
- **Пополнение:** сумма строго положительная; обязателен одноразовый код подтверждения.
- **Приоритетные счета:** пользователь может выбрать для каждой валюты (RUB, USD, EUR, CNY) счёт по умолчанию для зачисления переводов. Кнопка «Приоритетные счета» на главной странице.

**Ограничения:**
- Не более 3 счетов в рублях.
- Не более 3 счетов в сумме по иностранным валютам (USD, EUR, CNY вместе).
- С накопительного счёта нельзя выполнять переводы — только пополнение.

**Ошибки (с точки зрения пользователя):**

| Ситуация | Результат |
|----------|-----------|
| Превышен лимит счетов по валюте | Ошибка «лимит счетов превышен» |
| Счёт не найден или не принадлежит пользователю | Ошибка «не найден» |
| Счёт уже закрыт | Ошибка «счёт уже закрыт» |
| Закрытие при ненулевом балансе | Ошибка «для закрытия баланс должен быть нулевым» |
| Неверный код подтверждения | Ошибка «неверный код» |
| Сумма нулевая или отрицательная | Ошибка «сумма должна быть положительной» |

---

## Блок 8. Переводы (Transfers)

### Бизнес-требования

Пользователь может переводить деньги: между своими счетами, по номеру счёта, по телефону, а также обменивать валюту между своими счетами. Для каждой операции обязателен одноразовый код подтверждения.

- **Счёт списания:** только расчётный (DEBIT), активный. С накопительного переводить нельзя.
- **Перевод между своими счетами:** только в одной валюте.
- **Обмен валют:** только между счетами в разных валютах.
- **Перевод по номеру счёта:** указывается номер счёта получателя.
- **Перевод по телефону:** получатель ищется по номеру телефона из профиля. Зачисление — на его расчётный счёт в той же валюте. Во внешний банк — списание без зачисления (симуляция).

**Ограничения:**
- **Разовая операция:** от 10 до 300 000 включительно (в единицах валюты операции).
- **Суточный лимит** — отдельно по каждой валюте: рубли 1 000 000, доллары 10 000, евро 9 500, юани 70 000. Учитываются только переводы и обмен валют; платежи (мобильная связь, поставщики) в суточный лимит не входят.
- **Баланс:** на счёте списания должно быть достаточно средств.

**Ошибки (с точки зрения пользователя):**

| Ситуация | Результат |
|----------|-----------|
| Неверный код подтверждения | Ошибка «неверный код» |
| Перевод на тот же счёт | Ошибка «один и тот же счёт» |
| Сумма меньше 10 | Ошибка «сумма слишком мала» |
| Сумма больше 300 000 | Ошибка «превышен разовый лимит» |
| Превышен суточный лимит | Ошибка «превышен суточный лимит» |
| Счёт не найден | Ошибка «счёт не найден» |
| Нет доступа к счёту | Ошибка «доступ запрещён» |
| Счёт неактивен | Ошибка «счёт неактивен» |
| Списание с накопительного счёта | Ошибка «перевод с накопительного запрещён» |
| Разные валюты (или одинаковые при обмене) | Ошибка «несовпадение валют» |
| Недостаточно средств | Ошибка «недостаточно средств» |
| Получатель по телефону не найден | Ошибка «получатель не найден» |
| Нет подходящего счёта у получателя | Ошибка «нет подходящего счёта» |
| Неподдерживаемая пара валют для обмена | Ошибка «валютная пара не поддерживается» |

---

## Блок 9. Платежи (Payments)

### Бизнес-требования

Оплата мобильной связи и услуг поставщиков (ЖКХ, интернет, образование, благотворительность). Все платежи — только с рублёвого активного счёта. Для операции обязателен одноразовый код подтверждения.

- **Мобильная связь:** оператор из справочника; телефон в формате +7 и 10 цифр; сумма в рублях в заданном диапазоне.
- **Поставщики:** поставщик из справочника; лицевой счёт — только цифры, длина строго по провайдеру.

**Ограничения:**
- Только активный счёт в рублях (RUB).
- **Мобильная связь:** сумма от 100 до 12 000 ₽ включительно.
- **Поставщики:** сумма от 100 до 500 000 ₽ включительно.
- На счёте должно быть достаточно средств.

**Ошибки (с точки зрения пользователя):**

| Ситуация | Результат |
|----------|-----------|
| Неверный код подтверждения | Ошибка «неверный код» |
| Оператор не из справочника | Ошибка «оператор не поддерживается» |
| Поставщик не из справочника | Ошибка «поставщик не поддерживается» |
| Сумма вне допустимого диапазона | Ошибка «сумма вне диапазона» |
| Счёт не в рублях | Ошибка «требуется рублёвый счёт» |
| Неверная длина лицевого счёта | Ошибка «неверная длина лицевого счёта» |
| Счёт не найден | Ошибка «счёт не найден» |
| Недостаточно средств | Ошибка «недостаточно средств» |

---

## Блок 10. Статистика (Statistics)

### Бизнес-требования

Пользователь видит сводку по доходам и расходам на главной странице. Статистика помогает оценить движение средств по валютам.

**Что отображается:**
- **Доход** — полоска по валютам (RUB, USD, EUR, CNY). Учитываются: пополнения (в т.ч. через шляпу), зарплата от банка, подарки, входящие переводы.
- **Расход** — полоска по валютам. Учитываются: платежи (мобильная связь, поставщики — ЖКХ, интернет, образование, благотворительность), исходящие переводы, обмен валют.

**Зачем нужна:** пользователь видит, в какой валюте больше поступлений и трат. Переводы между своими счетами в статистику не входят.

**Ограничения:** данные строятся только по операциям из истории. Пустые полоски показывают «—».

---

## Блок 11. История операций (Transactions)

### Бизнес-требования

Пользователь может просматривать историю операций по своим счетам. В список попадают операции, которые пользователь инициировал сам, или где участвовали его счета (например, ему перевели по телефону). Операции отсортированы по дате — сначала новые.

**Типы операций:**
- **Пополнение** — через API, через шляпу (в т.ч. зарплата от банка, подарок).
- **Перевод** — между своими счетами, по номеру счёта, по телефону, обмен валют.
- **Платёж** — мобильная связь, поставщики (ЖКХ, интернет, образование, благотворительность).

**В интерфейсе (главная страница):** в блоке «Последние операции» изначально показываются 5 последних транзакций. Кнопка «Показать ещё» при каждом клике отображает дополнительно 10 операций.

**Ограничения:** пагинации нет, возвращаются все подходящие операции.

**Ошибки:** только при недействительной сессии или блокировке пользователя.

---

## Блок 12. Чек операции (Receipt)

### Бизнес-требования

Пользователь может сохранить чек по любой операции из истории. Чек нужен для подтверждения платежа или перевода (для отчётности, споров, бухгалтерии).

**Что должно быть в чеке:**
- **Заголовок** — банк и тип документа (чек операции).
- **Сумма и валюта** — сколько списано или зачислено.
- **Дата и время** — когда выполнена операция.
- **Счёт списания** — откуда ушли деньги (для расходов и переводов).
- **Счёт зачисления** — куда пришли деньги (для доходов и переводов).
- **Детали операции** — в зависимости от типа:
  - Платёж мобильной связи: оператор, номер телефона.
  - Платёж поставщику: поставщик, лицевой счёт.
  - Перевод: счёт или банк получателя, номер телефона (если по телефону).
  - Пополнение: источник (банк, зарплата, подарок).
- **Номер операции и статус** — для идентификации и проверки.

**Формат сохранения:** пользователь сохраняет чек в файл (HTML) для хранения на устройстве или печати. Печать в PDF возможна через браузер (Печать → Сохранить как PDF).

**Ограничения:** чек доступен только для операций из своей истории.
