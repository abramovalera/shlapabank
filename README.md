# ShlapaBank — учебный банковский проект

Учебный проект для практики написания API и UI тестов. Ниже по блокам — логика, ограничения, коды ошибок API (`detail`) и основные параметры ответов.

---

## Запуск

**1)** Скачайте проект к себе в удобную папку. На GitHub нажмите зелёную кнопку «Code» и выберите **Download ZIP**. Обязательно распакуйте архив — проект должен лежать в обычной папке, а не в ZIP.

![Скачать проект (Download ZIP)](docs/helpers/download-zip.png)

**2)** Скачайте и установите [Docker](https://www.docker.com/get-started) и зарегистрируйтесь (нужен аккаунт для скачивания образов).

**3)** Поднимите контейнеры из папки проекта. Откройте обычный терминал (CMD или PowerShell), перейдите в папку с распакованным проектом.
Например:

```powershell
cd C:\Users\Имя\Downloads\shlapabank
```

Затем выполните:

```powershell
docker compose up --build
```

Запущенный проект в Docker Desktop выглядит так (контейнеры **shlapabank**, **backend**, **db** в статусе Running):

![Запущенный проект в Docker](docs/helpers/docker-running.png)

После запуска откройте в браузере главную страницу интерфейса банка:

- **Главная страница (UI):** http://localhost:8001/ или http://localhost:8001/login  

---

## Для удобства

**Swagger** — доступен по клику «Swagger» в левом верхнем углу интерфейса.

**Страница входа:** ссылка «Не можете войти?» позволяет очистить кеш браузера при проблемах со входом.

![Swagger](docs/helpers/swagger.png)

**Читерская шляпа:** логотип-шляпа в левом верхнем углу. Клик открывает окно быстрого изменения баланса счетов (пополнение, списание или обнуление) без подтверждения. Пополнение создаёт запись в истории операций и учитывается в статистике. Администратор видит все счета в системе и может начислить зарплату на любой счёт; клиент — только пополнение и подарок на свои счета.

![Helper](docs/helpers/helper-ui.png)

---

## Формат ошибок API

При ошибке (4xx, 5xx) в теле ответа передаётся JSON с полем **`detail`**:

- **Обычные ошибки:** `detail` — строка с кодом (например `invalid_credentials`, `account_not_found`). Коды по блокам указаны в таблицах выше.
- **Валидация (422):** `detail` может быть массивом объектов с полями вроде `loc`, `msg`, `type` (уточнение по ручке — в Swagger) или строка с кодом вида `validation_error: login_not_unique`, `validation_error: password_equals_login` и т.д.

---

## Блок 1. Проверка доступности сервиса (Health)

### Бизнес-требования

Система должна позволять проверить, что банковское приложение доступно и работает. Эта проверка не требует входа в систему.

**Ограничения:** нет; проверка доступна всем.

**Ожидаемое поведение:** при доступности сервиса проверка всегда успешна.

**Способ проверки:** запрос `GET /api/v1/health` (без авторизации) или открытие главной страницы в браузере.

**Ответ API:** тело `{"status": "ok"}`.

---

## Блок 2. Вспомогательные операции (Helper)

### Бизнес-требования

Специальный режим для подготовки тестовых данных: получение одноразового кода подтверждения и изменение баланса счетов.

- **Получение кода подтверждения:** пользователь может получить одноразовый код из 4 цифр (эндпоинт и параметры — в Swagger). Код действует 1 минуту. Он нужен для подтверждения пополнения, переводов и платежей.
- **Пополнение баланса:** пользователь может увеличить баланс счёта. Операция создаёт запись в истории и учитывается в статистике. Можно указать тип дохода: пополнение, подарок или зарплата (только для администратора). Администратор может пополнять любой счёт в системе, клиент — только свои.
- **Списание и обнуление:** пользователь может уменьшить или обнулить баланс своего счёта. При списании баланс не может стать отрицательным. Эти операции не создают записей в истории.

**Ограничения:**
- Клиент работает только со своими счетами; администратор — с любыми (для начисления зарплаты).
- С закрытым счётом операции запрещены.
- При списании — проверка достаточности средств.
- Зарплату может начислить только администратор.

**Ошибки (с точки зрения пользователя):**

| Ситуация | Код ответа API (`detail`) |
|----------|---------------------------|
| Счёт не найден или не принадлежит пользователю | `account_not_found` |
| Счёт закрыт | `account_inactive` |
| Недостаточно средств при списании | `insufficient_funds` |
| Сумма или итоговый баланс превышают лимит | `amount_too_large` |
| Зарплату запросил не админ | `salary_credit_admin_only` |
| *Техническая ошибка:* требуется миграция БД (колонка `fee` в таблице транзакций) | `database_migration_required` |

**Лимит суммы и баланса:** максимум 12 знаков до запятой и 2 после (например 999 999 999 999.99). Лимит применяется и к сумме одной операции, и к итоговому балансу счёта после операции.

---

## Блок 3. Администрирование (Admin)

### Бизнес-требования

Администратор управляет пользователями и счетами: просматривает список пользователей, блокирует и разблокирует их, удаляет (для очистки тестовых данных), просматривает и пополняет счета, просматривает транзакции, настраивает банки для перевода по телефону.

- **Пополнение счёта:** администратор указывает сумму (обязательно положительную) и пополняет любой счёт.
- **Банки для перевода по телефону:** у пользователя может быть от 0 до 5 внешних банков. Наш банк в список не включается. Нельзя указать несуществующий банк.

**Ограничения:**
- Доступ только у роли администратор; обычный клиент не может выполнять эти действия.
- Администратора по умолчанию удалить нельзя.
- Максимум 5 банков на пользователя.

**Ошибки (с точки зрения пользователя):**

| Ситуация | Код ответа API (`detail`) |
|----------|---------------------------|
| Пользователь не найден | `user_not_found` |
| Счёт не найден | `account_not_found` |
| Сумма нулевая или отрицательная | (валидация 400) |
| Указан наш банк или несуществующий банк | `invalid_bank_codes` |
| Больше 5 банков | `bank_limit_exceeded` |
| Попытка удалить администратора по умолчанию | `cannot_delete_admin` |

---

## Блок 4. Регистрация и вход (Auth)

### Бизнес-требования

**Регистрация** — создание нового пользователя по логину и паролю.

- **Логин:** от 6 до 20 символов включительно, только латиница (A–Z, a–z) и цифры (0–9); без пробелов, кириллицы и спецсимволов. Логин должен быть уникален в системе.
- **Пароль:** от 8 до 30 символов включительно, минимум 1 строчная буква, 1 заглавная, 1 цифра, 1 спецсимвол, без пробелов, не должен совпадать с логином.

При регистрации пользователю назначается случайный набор 0–5 внешних банков для переводов по телефону.

**Вход** — проверка логина и пароля, выдача доступа к защищённым функциям.

**Ограничения:**
- После 5 неудачных попыток входа подряд пользователь блокируется. Разблокировать может только администратор.
- При успешном входе счётчик неудачных попыток сбрасывается.

**Ошибки (с точки зрения пользователя):**

| Ситуация | Код ответа API (`detail`) |
|----------|---------------------------|
| Неверный логин или пароль | `invalid_credentials` |
| Пользователь заблокирован | `user_blocked` (403) |
| Логин уже занят (регистрация) | `validation_error: login_not_unique` |
| Пароль совпадает с логином | `validation_error: password_equals_login` (422) |
| Пароль не соответствует правилам (нет нужных символов) | `validation_error: weak_password` (422) |
| В пароле есть пробел | `validation_error: password_contains_space` (422) |
| Некорректный формат данных (длина, символы логина) | ошибка валидации 422 с описанием полей |

**Ответ API при успешном входе:** `access_token`, `token_type` (bearer), `role` (ADMIN или CLIENT). Токен передаётся в заголовке `Authorization`.

---

## Блок 5. Сессия пользователя

### Бизнес-требования

Большинство операций требуют, чтобы пользователь был авторизован. Сессия создаётся при успешном входе.

- **Срок действия сессии:** 60 минут, не настраивается. После истечения нужен повторный вход.
- **Защищённые операции:** все, кроме проверки доступности, регистрации и входа.
- **Истёкшая или недействительная сессия:** доступ к защищённым операциям запрещён.
- **Заблокированный пользователь:** доступ запрещён даже при действующей сессии.

**Ограничения:** без действующей сессии доступ к защищённым операциям запрещён.

**Ошибки (с точки зрения пользователя):**

| Ситуация | Код ответа API (`detail`) |
|----------|---------------------------|
| Сессия истекла или недействительна | `invalid_token` (401) |
| Пользователь заблокирован | `user_blocked` (403) |

---

## Блок 6. Профиль пользователя (Profile)

### Бизнес-требования

Пользователь может просматривать и обновлять свои данные: имя, фамилия, телефон, email, смена пароля.

- **Имя, фамилия:** только буквы (латиница и кириллица), длина 1–100 символов. Необязательно.
- **Телефон:** в API принимается и возвращается строка в формате `+79XXXXXXXXX` (12 символов, без пробелов и скобок). Необязательно.
- **Email:** корректный адрес почты. Необязательно.
- **Смена пароля:** обязательно указать текущий и новый пароль. Правила для нового пароля — как при регистрации. Новый пароль не должен совпадать с текущим.

**Ограничения:**
- Телефон и email уникальны в системе; при совпадении с другим пользователем — ошибка.
- Длина имени и фамилии — не более 100 символов.

**Ошибки (с точки зрения пользователя):**

| Ситуация | Код ответа API (`detail`) |
|----------|---------------------------|
| Телефон уже используется | `validation_error: phone_not_unique` |
| Email уже используется | `validation_error: email_not_unique` |
| Указан только текущий или только новый пароль | `validation_error: password_change_requires_both_fields` |
| Неверный текущий пароль | `invalid_current_password` |
| Новый пароль совпадает с текущим | `validation_error: password_reuse_not_allowed` |

**Ответ API (профиль):** `id`, `login`, `email`, `role`, `status`, `first_name`, `last_name`, `phone`.

---

## Блок 7. Счета (Accounts)

### Бизнес-требования

Пользователь управляет своими банковскими счетами: просматривает список активных счетов, создаёт новые, закрывает, пополняет.

- **Создание счёта:** пользователь выбирает тип счёта и валюту.
  - **Расчётный (DEBIT):** с него можно переводить, платить и пополнять.
  - **Накопительный (SAVINGS):** только пополнение и хранение, переводить с него нельзя.
  - **Валюты:** рубли (RUB), доллары (USD), евро (EUR), юани (CNY).
  - Номер счёта выдаётся автоматически.
- **Закрытие счёта:** возможно только при нулевом балансе.
- **Пополнение:** сумма строго положительная; обязателен одноразовый код подтверждения.
- **Приоритетные счета:** пользователь может выбрать для каждой валюты (RUB, USD, EUR, CNY) счёт по умолчанию для зачисления переводов. В UI — кнопка «Приоритетные счета» на главной странице. Через API: метод и путь см. в Swagger (тело запроса — список до 4 id счетов; у указанных выставляется приоритет).

**Ограничения:**
- Не более 3 счетов в рублях.
- Не более 3 счетов суммарно по всем иностранным валютам (USD, EUR, CNY вместе).
- С накопительного счёта нельзя выполнять переводы — только пополнение.

**Ошибки (с точки зрения пользователя):**

| Ситуация | Код ответа API (`detail`) |
|----------|---------------------------|
| Превышен лимит счетов по валюте | `account_limit_exceeded` |
| Счёт не найден или не принадлежит пользователю | `account_not_found` |
| Счёт уже закрыт | `account_already_closed` |
| Закрытие при ненулевом балансе | `account_close_requires_zero_balance` |
| Неверный код подтверждения | `invalid_otp_code` |
| Сумма нулевая или отрицательная | `amount_must_be_positive` |

**Ответ API (список счетов):** массив объектов с полями `id`, `account_number`, `account_type` (DEBIT/SAVINGS), `currency` (RUB/USD/EUR/CNY), `balance`, `is_primary`.

**Ответ API (пополнение счёта):** объект операции (транзакция) — см. блок 11.

---

## Блок 8. Переводы (Transfers)

### Бизнес-требования

Пользователь может переводить деньги: между своими счетами, по номеру счёта, по телефону (внутри банка или во внешний банк), а также обменивать валюту между своими счетами. Для операций, кроме перевода между своими счетами, обязателен одноразовый код подтверждения.

- **Счёт списания:** только расчётный (DEBIT), активный. С накопительного переводить нельзя.
- **Перевод между своими счетами:** только в одной валюте. Без комиссии.
- **Обмен валют:** только между счетами в разных валютах; разрешены любые пары из RUB, USD, EUR, CNY (конвертация по справочнику курсов). Без комиссии.
- **Перевод по номеру счёта:** указывается номер счёта получателя (16 цифр). Если счёт найден в нашем банке — зачисление на него, без комиссии. Если счёт **не найден** в нашем банке — это перевод во внешний банк: списание суммы + **комиссия 5%** (итого списывается с баланса сумма перевода и комиссия).
- **Перевод по телефону:** получатель ищется по номеру телефона из профиля. Если он в нашем банке — зачисление на его расчётный счёт в той же валюте, без комиссии. Если выбран **внешний банк** — списание суммы + **комиссия 2%** (симуляция перевода в другой банк).

**Ограничения:**
- **Разовая операция:** от 10 до 300 000 включительно (в единицах валюты операции). При переводе во внешний банк лимит 300 000 относится к сумме перевода; комиссия списывается сверху (итого списание может быть выше 300 000).
- **Суточный лимит** — отдельно по каждой валюте: рубли 1 000 000, доллары 10 000, евро 9 500, юани 70 000. Учитываются только переводы и обмен валют; платежи в суточный лимит не входят.
- **Баланс:** на счёте списания должно быть достаточно средств (при комиссии проверяется сумма + комиссия).

**Ошибки (с точки зрения пользователя):**

| Ситуация | Код ответа API (`detail`) |
|----------|---------------------------|
| Неверный код подтверждения | `invalid_otp_code` |
| Перевод на тот же счёт | `transfer_same_account` |
| Сумма меньше 10 | `transfer_amount_too_small` |
| Сумма больше 300 000 | `transfer_amount_exceeds_single_limit` |
| Превышен суточный лимит | `transfer_amount_exceeds_daily_limit` |
| Счёт не найден | `account_not_found` |
| Нет доступа к счёту | `forbidden_account_access` |
| Счёт неактивен | `account_inactive` |
| Списание с накопительного счёта | `transfer_not_allowed_from_savings` |
| Разные валюты (или одинаковые при обмене) | `currency_mismatch` |
| Недостаточно средств (в т.ч. с учётом комиссии) | `insufficient_funds` |
| Получатель по телефону в нашем банке не найден | `recipient_not_found_in_our_bank` |
| Нет подходящего счёта у получателя | `recipient_has_no_suitable_account` |
| Неподдерживаемая пара валют для обмена | `currency_not_supported_for_exchange` |
| Номер счёта не 16 цифр (проверка счёта / перевод по счёту) | `invalid_account_number` |
| При переводе по телефону выбран внешний банк, но номер принадлежит клиенту нашего банка | `account_found_in_bank` |

**Ответ API (успешный перевод / обмен):** объект операции (транзакция) — см. блок 11. Поля: `type` (TRANSFER), `money`, `from_account_id`, `to_account_id` (у внешнего перевода может быть `null`), `description`, `created_at`, `status`.

---

## Блок 9. Платежи (Payments)

### Бизнес-требования

Оплата мобильной связи и услуг поставщиков (ЖКХ, интернет, образование, благотворительность). Все платежи — только с рублёвого активного счёта. Для операции обязателен одноразовый код подтверждения.

- **Мобильная связь:** оператор из справочника (справочник — через API, путь в Swagger); телефон в формате +7 и 10 цифр; сумма в рублях в заданном диапазоне.
- **Поставщики:** поставщик из справочника; лицевой счёт — только цифры, длина строго по провайдеру (справочник поставщиков и длина лицевого счёта по каждому — через API, путь в Swagger).

**Ограничения:**
- Только активный счёт в рублях (RUB).
- **Мобильная связь:** сумма от 100 до 12 000 ₽ включительно.
- **Поставщики:** сумма от 100 до 500 000 ₽ включительно.
- На счёте должно быть достаточно средств.

**Ошибки (с точки зрения пользователя):**

| Ситуация | Код ответа API (`detail`) |
|----------|---------------------------|
| Неверный код подтверждения | `invalid_otp_code` |
| Оператор не из справочника | `payment_operator_not_supported` |
| Поставщик не из справочника | `payment_provider_not_supported` |
| Сумма вне допустимого диапазона | `payment_amount_out_of_range` |
| Счёт не в рублях | `payment_requires_rub_account` |
| Неверная длина лицевого счёта | `payment_account_number_invalid_length` |
| Счёт не найден | `account_not_found` |
| Недостаточно средств | `insufficient_funds` |

**Ответ API (успешный платёж):** объект операции (транзакция) — см. блок 11. `type` = PAYMENT, в `money` комиссия 0.

---

## Блок 10. Статистика (Statistics)

### Бизнес-требования

На главной странице отображается сводка по доходам и расходам по валютам.

**Что отображается:**
- **Доход** — полоска по валютам (RUB, USD, EUR, CNY). Учитываются: пополнения (в т.ч. через шляпу), зарплата от банка, подарки, входящие переводы.
- **Расход** — полоска по валютам. Учитываются: платежи (мобильная связь, поставщики), исходящие переводы, обмен валют.

Переводы между своими счетами в статистику не входят.

**Ограничения:** данные строятся только по операциям из истории. Пустые полоски показывают «—». Формат ответа API (поля по валютам, суммы доходов/расходов) — в Swagger.

---

## Блок 11. История операций (Transactions)

### Бизнес-требования

Пользователь может просматривать историю операций по своим счетам. В список попадают операции, которые пользователь инициировал сам, или где участвовали его счета (например, ему перевели по телефону). Операции отсортированы по дате — сначала новые.

**Типы операций:**
- **Пополнение (TOPUP)** — через API, через шляпу (в т.ч. зарплата от банка, подарок).
- **Перевод (TRANSFER)** — между своими счетами, по номеру счёта, по телефону (внутри банка или во внешний), обмен валют.
- **Платёж (PAYMENT)** — мобильная связь, поставщики (ЖКХ, интернет, образование, благотворительность).

**В интерфейсе (главная страница):** в блоке «Последние операции» изначально показываются 5 последних транзакций. Кнопка «Показать ещё» при каждом клике отображает дополнительно 10 операций.

**Ограничения:** пагинации в API нет — возвращаются все подходящие операции без ограничения по количеству. В интерфейсе показ по 5 и «ещё по 10» реализован только на стороне UI.

**Ошибки:** только при недействительной сессии или блокировке пользователя (`invalid_token`, `user_blocked`).

### Ответ API (список операций и одна операция)

Тело ответа — массив объектов (или один объект при создании перевода/платежа/пополнения). Основные поля:

| Параметр | Тип / значения |
|----------|----------------|
| `id` | число. Используется в запросе чека: `/transactions/{id}/receipt`. |
| `type` | строка: `TOPUP`, `TRANSFER`, `PAYMENT`. |
| `money` | объект: `amount`, `fee`, `total`, `currency`. |
| `money.amount` | строка (число с 2 знаками) — сумма операции без комиссии. |
| `money.fee` | строка (число с 2 знаками) — комиссия (0.00 если нет). |
| `money.total` | строка — amount + fee. |
| `money.currency` | строка: `RUB`, `USD`, `EUR`, `CNY`. |
| `description` | строка или null (например `p2p_transfer`, `external_transfer:...`, `mobile:...`). |
| `created_at` | строка (дата-время). |
| `from_account_id` | число или null (null у пополнения). |
| `to_account_id` | число или null (null у платежа или перевода во внешний банк). |
| `status` | строка: `COMPLETED`, `FAILED`. |

Пример фрагмента ответа:

```json
{
  "id": 15,
  "type": "TRANSFER",
  "money": { "amount": "1500.00", "fee": "0.00", "total": "1500.00", "currency": "RUB" },
  "description": "p2p_transfer",
  "created_at": "2026-02-26T12:34:56.000000",
  "from_account_id": 1,
  "to_account_id": 2,
  "status": "COMPLETED"
}
```

---

## Блок 12. Чек операции (Receipt)

### Бизнес-требования

Пользователь может сохранить чек по любой операции из истории.

**Что в чеке:** заголовок (банк, название), сумма и валюта (с комиссией при наличии), дата и время, тип операции (`type`), счёт списания (`from_account_id`), счёт зачисления (`to_account_id`), детали по типу (оператор/телефон, поставщик/лицевой счёт, перевод/банк/телефон, пополнение/источник), номер операции и статус (`id`, `status`).

Чек отдаётся как HTML (Content-Type: text/html). Запрос: `GET /api/v1/transactions/{id}/receipt` (с токеном). Доступен только по операциям из своей истории; при запросе чека по чужой или несуществующей операции — ответ 404, `detail`: `not_found`.
