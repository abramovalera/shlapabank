# ShlapaBank — учебный банковский API

Учебный проект для практики написания API-тестов. Backend (FastAPI) + статичный UI. Подготовка данных — только через API, без доступа к БД.

---

## Запуск

```powershell
docker compose up --build
```

- **Swagger:** http://localhost:8001/docs  
- **UI:** http://localhost:8001/ui/  
- **API base URL:** http://localhost:8001/api/v1  

**Важно:** все ручки (кроме `/health`, `/auth/register`, `/auth/login`) требуют заголовка `Authorization: Bearer <token>`. Токен получают через `POST /auth/login`.

---

## Для удобства:

Swagger доступен прямо в интерфейсе банка — клик по «Swagger» в левом верхнем углу.

![Swagger](docs/helpers/swagger.png)

Для удобства работы есть читерская шляпа — можно кликнуть по шляпе, откроется окно, в котором можно указать счёт, вписать сумму на пополнение/снятие или обнулить баланс.

![Helper](docs/helpers/helper-ui.png)

---

## Блок 1. Health

### Зачем нужен

Проверка доступности сервиса. Используется для smoke-тестов и мониторинга.

### Требования

- Ручка публичная, авторизация не нужна.

### Ограничения

- Нет.

### Ручки

| Метод | Путь | Описание |
|-------|------|----------|
| GET | `/health` | Проверка доступности (без префикса /api/v1). Ответ: `{"status": "ok"}` |

---

## Блок 2. Helper

### Зачем нужен

Вспомогательные ручки для подготовки данных в тестах: получение OTP, изменение баланса без OTP и без создания транзакций. В UI — Helper (клик по логотипу).

### Требования

- Авторизация: Bearer-токен.
- Пользователь активен.
- Работа только со своими активными счетами.

### Ограничения

- Транзакции не создаются. Для «настоящего» пополнения используйте `POST /accounts/{id}/topup`.
- OTP из `otp/preview` живёт 5 минут и привязан к пользователю.

### Ручки

| Метод | Путь | Описание |
|-------|------|----------|
| GET | `/helper/otp/preview` | Получить OTP для операций (динамический, живёт 5 минут) |
| POST | `/helper/accounts/{account_id}/increase?amount=...` | Увеличить баланс на amount |
| POST | `/helper/accounts/{account_id}/decrease?amount=...` | Уменьшить баланс на amount |
| POST | `/helper/accounts/{account_id}/zero` | Обнулить баланс |
| POST | `/helper/clear-browser` | Сброс состояния: очистить localStorage, sessionStorage и перейти на страницу входа (для E2E-тестов) |

### Коды ошибок

| Код | detail | Когда |
|-----|--------|-------|
| 404 | `account_not_found` | Счёт не найден или не свой |
| 400 | `account_inactive` | Счёт закрыт |
| 400 | `insufficient_funds` | Недостаточно средств при decrease |

---

## Блок 3. Админ (Admin)

### Зачем нужен

Управление пользователями и счетами от имени администратора. Нужен для подготовки данных в тестах (блокировка, пополнение чужих счетов).

### Требования

- Авторизация: Bearer-токен пользователя с ролью `ADMIN`.
- Дефолтный админ: `admin` / `admin` (если не задано в `.env`).
- Админ выполняет все операции без OTP.

### Ограничения

- Только роль ADMIN. Клиент → 403 `forbidden`.
- Банки для перевода по телефону: 0–5 внешних банков на пользователя. Наш банк в список не включается.

### Ручки

| Метод | Путь | Описание |
|-------|------|----------|
| GET | `/admin/users` | Список всех пользователей |
| POST | `/admin/users/{user_id}/block` | Заблокировать пользователя |
| POST | `/admin/users/{user_id}/unblock` | Разблокировать пользователя |
| DELETE | `/admin/users/{user_id}` | Удалить пользователя (для очистки тестовых данных). Дефолтного админа удалить нельзя |
| POST | `/admin/accounts/{account_id}/credit` | Пополнить счёт от имени админа. Тело: `{"amount": "10000.00"}` |
| GET | `/admin/transactions` | Все транзакции системы |
| GET | `/admin/users/{user_id}/banks` | Список банков для перевода по телефону у пользователя |
| PUT | `/admin/users/{user_id}/banks` | Изменить банки. Тело: `{"bank_codes": ["alpha", "tinkoff", "sber", ...]}`. Коды — из `GET /transfers/by-phone/check` (кроме «Наш банк»). |

### Коды ошибок

| Код | detail | Когда |
|-----|--------|-------|
| 404 | `not_found` | Пользователь не найден |
| 404 | `account_not_found` | Счёт не найден |
| 400 | `amount_must_be_positive` | Сумма ≤ 0 |
| 400 | `invalid_bank_codes: ...` | Указан наш банк или несуществующий |
| 400 | `max_5_banks_allowed` | Больше 5 банков |
| 400 | `cannot_delete_admin` | Попытка удалить дефолтного админа |

---

## Блок 4. Авторизация (Auth)

### Зачем нужен

Регистрация новых пользователей и вход в систему. После успешного входа выдаётся JWT-токен, который нужен для доступа к защищённым ручкам.

### Требования

**Регистрация:**
- `login` — 6–20 символов. Разрешены только латиница (A–Z, a–z) и цифры (0–9). Запрещены: пробелы, кириллица, спецсимволы (_, -, @ и т.д.).
- `password` — 8–30 символов. Обязательно: минимум 1 строчная буква, 1 заглавная, 1 цифра, 1 спецсимвол. Без пробелов. Не должен совпадать с логином.
- Банки при регистрации — при регистрации назначается случайный набор 0–5 внешних банков для переводов по телефону. Подробнее — см. [Переводы: банки для перевода по телефону](#блок-8-переводы-transfers).

**Для тестируемости:** подготовка данных только через API (Helper, Admin) без доступа к БД; OTP — из `GET /helper/otp/preview`; админ — для пополнения любого счёта и блокировки пользователей.

**Логин:**
- `login` — 1–20 символов.
- `password` — 1–100 символов.

### Ограничения

- Логин уникален. Повторная регистрация с тем же логином → 409.
- После 5 неудачных попыток входа пользователь блокируется. Дальнейший логин → 403 `user_blocked`.
- При успешном входе счётчик неудачных попыток сбрасывается.

### Ручки

| Метод | Путь | Описание |
|-------|------|----------|
| POST | `/auth/register` | Регистрация. Тело: `{"login": "...", "password": "..."}`. Ответ 201: объект пользователя (id, login, role, status и т.д.). |
| POST | `/auth/login` | Вход. Тело: `{"login": "...", "password": "..."}`. Ответ 200: `{"access_token": "...", "token_type": "bearer"}`. |

### Коды ошибок

| Код | detail | Когда |
|-----|--------|-------|
| 401 | `invalid_credentials` | Неверный логин или пароль |
| 403 | `user_blocked` | Пользователь заблокирован |
| 409 | `validation_error: login_not_unique` | Логин уже занят |
| 400 | `validation_error: password_equals_login` | Пароль совпадает с логином |
| 400 | `validation_error: weak_password` | Пароль не соответствует правилам |
| 400 | `validation_error: password_contains_space` | В пароле есть пробел |
| 422 | — | Ошибка валидации Pydantic (длина, формат, обязательные поля). Тело ответа содержит `detail` с описанием. |

---

## Блок 5. Аутентификация (JWT)

### Зачем нужен

Большинство ручек требуют авторизации. Токен, полученный при логине, передаётся в заголовке `Authorization`.

### Требования

- Заголовок: `Authorization: Bearer <access_token>`.
- Токен выдаётся при успешном `POST /auth/login`.

### Ограничения

- Токен имеет срок жизни (по умолчанию 60 минут, настраивается через `ACCESS_TOKEN_EXPIRE_MINUTES`).
- Истёкший или невалидный токен → 401 `invalid_token`.
- Заблокированный пользователь → 403 `user_blocked` (даже при валидном токене).

### Какие ручки защищены

Все, кроме `/health`, `/auth/register`, `/auth/login`. В Swagger защищённые ручки помечены замком; для вызова нужно нажать «Authorize» и ввести `Bearer <token>`.

---

## Блок 6. Профиль (Profile)

### Зачем нужен

Просмотр и обновление данных текущего пользователя: имя, фамилия, телефон, email, смена пароля.

### Требования

- Авторизация: Bearer-токен.
- Пользователь должен быть активен (не заблокирован).

**Обновление профиля (PUT):**
- `first_name`, `last_name` — только буквы (латиница и кириллица), 1–100 символов. Опционально.
- `phone` — формат `+7XXXXXXXXXX` (10 цифр после +7). Опционально.
- `email` — валидный email. Опционально.
- Смена пароля: обязательно оба поля — `current_password` и `new_password`. Правила для `new_password` те же, что при регистрации. Новый пароль не должен совпадать с текущим.

### Ограничения

- Телефон и email уникальны в системе. При совпадении с другим пользователем → 409.

### Ручки

| Метод | Путь | Описание |
|-------|------|----------|
| GET | `/profile` | Получить профиль текущего пользователя |
| PUT | `/profile` | Обновить профиль. Тело: частичный JSON (только нужные поля). |

### Коды ошибок

| Код | detail | Когда |
|-----|--------|-------|
| 409 | `validation_error: phone_not_unique` | Телефон уже используется |
| 409 | `validation_error: email_not_unique` | Email уже используется |
| 400 | `validation_error: password_change_requires_both_fields` | Указан только current или только new password |
| 401 | `invalid_current_password` | Неверный текущий пароль |
| 400 | `validation_error: password_reuse_not_allowed` | Новый пароль совпадает с текущим |

---

## Блок 7. Счета (Accounts)

### Зачем нужен

Управление банковскими счетами пользователя: список, создание, закрытие. Пополнение — через админа (`POST /admin/accounts/{id}/credit`) или Helper (см. блок 2).

### Требования

- Авторизация: Bearer-токен.
- Пользователь активен.

**Создание счёта (POST):**
- `account_type`: `DEBIT` или `SAVINGS`.
- `currency`: `RUB`, `USD`, `EUR`, `CNY`.

**Пополнение (POST `/{account_id}/topup`):** API для автотестов. В UI — через Helper или админа. Тело: `amount` (положительное), `otp_code` (4 цифры; **только** из `GET /helper/otp/preview`).

### Ограничения

- Лимиты по количеству счетов: до 3 в RUB, до 3 в сумме по USD/EUR/CNY.
- Закрытие счёта возможно только при нулевом балансе.
- С накопительного счёта (SAVINGS) нельзя переводить — только с DEBIT.
- Номер счёта генерируется автоматически (маска по валюте: 2202… для RUB, 3202… для USD и т.д.).

### Ручки

| Метод | Путь | Описание |
|-------|------|----------|
| GET | `/accounts` | Список активных счетов пользователя |
| POST | `/accounts` | Создать счёт. Тело: `{"account_type": "DEBIT", "currency": "RUB"}` |
| DELETE | `/accounts/{account_id}` | Закрыть счёт (баланс должен быть 0) |
| POST | `/accounts/{account_id}/topup` | Пополнить счёт (для автотестов). Тело: `amount`, `otp_code` (из `GET /helper/otp/preview`) |

### Коды ошибок

| Код | detail | Когда |
|-----|--------|-------|
| 400 | `account_limit_exceeded` | Превышен лимит счетов по валюте |
| 404 | `not_found` | Счёт не найден или не принадлежит пользователю |
| 400 | `account_already_closed` | Счёт уже закрыт |
| 400 | `account_close_requires_zero_balance` | Закрытие при ненулевом балансе |
| 400 | `invalid_otp_code` | Неверный OTP |
| 400 | `amount_must_be_positive` | Сумма ≤ 0 |
| 404 | `account_not_found` | Счёт не найден при topup |

---

## Блок 8. Переводы (Transfers)

### Зачем нужен

Переводы между счетами (своими и чужим по номеру счёта/телефона), обмен валют.

### Требования

- Авторизация: Bearer-токен.
- Пользователь активен.
- Для подтверждения операций требуется OTP.
- OTP: 4 цифры, **только** из `GET /helper/otp/preview` (динамический, живёт 5 минут).

### Ограничения

**Лимиты:**
- Разовая операция: 10–300 000 (в единицах валюты операции).
- **Суточный лимит — отдельно по каждой валюте** (в единицах валюты, на пользователя за день):

| Валюта | Суточный лимит |
|--------|----------------|
| RUB    | 1 000 000 ₽     |
| USD    | 10 000 $       |
| EUR    | 9 500 €        |
| CNY    | 70 000 ¥       |

- Суточный лимит применяется к переводам (`/transfers`, `/by-account`, `/by-phone`) и обмену валют (`/exchange`). Платежи (mobile, vendor) в лимит не входят.
- Курсы к RUB фиксированы (RUB=1, USD≈95, EUR≈105, CNY≈13.5).

**Правила:**
- Счёт списания — только DEBIT, активный.
- Перевод между счетами — только в одной валюте.
- Обмен — только между счетами в разных валютах.
- Перевод по телефону: получатель в нашем банке — зачисление на его DEBIT-счёт в той же валюте; во внешний банк — списание без зачисления (симуляция). Получатель в нашем банке ищется по номеру телефона из профиля (должен быть установлен через `PUT /profile`).
- **Банки для перевода по телефону:** у каждого получателя — от 0 до 5 внешних банков. При регистрации назначается случайный набор; наш банк в список не включается. Админ может изменить список через `PUT /admin/users/{user_id}/banks`.

### Ручки

| Метод | Путь | Описание |
|-------|------|----------|
| GET | `/transfers/rates` | Курсы валют к RUB |
| GET | `/transfers/daily-usage` | Остаток суточного лимита по каждой валюте. Возвращает `limits.perCurrency`: для каждой валюты — `dailyLimit`, `usedToday`, `remaining` |
| POST | `/transfers` | Перевод между своими счетами по ID. Тело: `from_account_id`, `to_account_id`, `amount`, `otp_code` |
| POST | `/transfers/by-account` | Перевод по номеру счёта получателя. Тело: `from_account_id`, `target_account_number`, `amount`, `otp_code` |
| GET | `/transfers/by-phone/check?phone=+7...` | Проверка: получатель в нашем банке или нет; список доступных банков |
| POST | `/transfers/by-phone` | Перевод по телефону. Тело: `from_account_id`, `phone`, `recipient_bank_id`, `amount`, `otp_code` |
| POST | `/transfers/exchange` | Обмен валют между своими счетами. Тело: `from_account_id`, `to_account_id`, `amount`, `otp_code` |

### Коды ошибок

| Код | detail | Когда |
|-----|--------|-------|
| 400 | `invalid_otp_code` | Неверный OTP |
| 400 | `transfer_same_account` | Откуда и куда — один счёт |
| 400 | `transfer_amount_too_small` | Сумма < 10 |
| 400 | `transfer_amount_exceeds_single_limit` | Сумма > 300 000 |
| 400 | `transfer_amount_exceeds_daily_limit` | Превышен суточный лимит |
| 404 | `account_not_found` | Счёт не найден |
| 403 | `forbidden_account_access` | Нет доступа к счёту |
| 400 | `account_inactive` | Счёт неактивен |
| 400 | `transfer_not_allowed_from_savings` | Списание с SAVINGS |
| 400 | `currency_mismatch` | Разные валюты (или одинаковые при обмене) |
| 400 | `insufficient_funds` | Недостаточно средств |
| 404 | `recipient_not_found_in_our_bank` | Получатель по телефону не найден |
| 400 | `recipient_has_no_suitable_account` | Нет подходящего DEBIT-счёта у получателя |
| 400 | `currency_not_supported_for_exchange` | Неподдерживаемая пара валют |

---

## Блок 9. Платежи (Payments)

### Зачем нужен

Оплата мобильной связи и услуг поставщиков (ЖКХ, интернет, образование, благотворительность). Все платежи — только с рублёвого счёта.

### Требования

- Авторизация: Bearer-токен.
- Пользователь активен.
- Для подтверждения операций требуется OTP.
- OTP: 4 цифры, **только** из `GET /helper/otp/preview` (динамический, живёт 5 минут).

**Мобильная связь:**
- `operator` — из справочника `GET /payments/mobile/operators`.
- `phone` — формат `+7XXXXXXXXXX`.
- `amount` — 100–12 000 ₽.

**Поставщики (ЖКХ, интернет, образование, благотворительность):**
- Один эндпоинт `POST /payments/vendor` для всех категорий.
- `provider` — из справочника `GET /payments/vendor/providers` (имя и требуемая длина `account_number`).
- `account_number` — только цифры, длина строго по провайдеру (10–22 символов).

### Ограничения

- Счёт списания — только RUB, активный.
- Мобильная связь: 100–12 000 ₽.
- Поставщики: 100–500 000 ₽.

### Ручки

| Метод | Путь | Описание |
|-------|------|----------|
| GET | `/payments/mobile/operators` | Справочник операторов и лимитов |
| GET | `/payments/vendor/providers` | Справочник поставщиков и длин лицевых счетов |
| POST | `/payments/mobile` | Оплата мобильной связи. Тело: `account_id`, `operator`, `phone`, `amount`, `otp_code` |
| POST | `/payments/vendor` | Оплата поставщику. Тело: `account_id`, `provider`, `account_number`, `amount`, `otp_code` |

### Коды ошибок

| Код | detail | Когда |
|-----|--------|-------|
| 400 | `invalid_otp_code` | Неверный OTP |
| 400 | `payment_operator_not_supported` | Оператор не из справочника |
| 400 | `payment_provider_not_supported` | Поставщик не из справочника |
| 400 | `payment_amount_out_of_range` | Сумма вне диапазона |
| 400 | `payment_requires_rub_account` | Счёт не в RUB |
| 400 | `payment_account_number_invalid_length` | Неверная длина лицевого счёта |
| 404 | `account_not_found` | Счёт не найден |
| 400 | `insufficient_funds` | Недостаточно средств |

---

## Блок 10. Транзакции (Transactions)

### Зачем нужен

История финансовых операций пользователя. Полезно для проверки, что после topup/transfer/payment создалась запись с ожидаемыми полями.

### Требования

- Авторизация: Bearer-токен.
- Пользователь активен.

### Ограничения

- Возвращаются только транзакции, инициированные пользователем или затрагивающие его счета.

### Ручки

| Метод | Путь | Описание |
|-------|------|----------|
| GET | `/transactions` | История операций пользователя. Сортировка по дате (новые первые). |

**Типы транзакций:** `TOPUP`, `TRANSFER`, `PAYMENT`.  
**Поле `description`:** `admin_credit`, `self_topup`, `p2p_transfer`, `p2p_transfer_by_account`, `p2p_transfer_by_phone`, `p2p_by_phone_external:...`, `fx_exchange:...`, `mobile:...`, `vendor:...`.

---

## Блок 11. Настройки (Settings)

### Зачем нужен

Пользовательские настройки UI (тема, язык, уведомления). В MVP — фиксированный ответ.

### Требования

- Авторизация: Bearer-токен.

### Ручки

| Метод | Путь | Описание |
|-------|------|----------|
| GET | `/settings` | Настройки. Ответ: `theme`, `language`, `notificationsEnabled`. |

---

## Подготовка к API-тестам (первые шаги)

1. Запустить сервер: `docker compose up --build`.
2. Регистрация: `POST /auth/register` с телом `{"login": "testuser", "password": "ValidPass123!"}` → получить пользователя (id, login, role, status).
3. Логин: `POST /auth/login` с тем же телом → получить `access_token`.
4. Дальнейшие запросы: заголовок `Authorization: Bearer <access_token>`.
5. OTP для операций (переводы, платежи): **только** из `GET /helper/otp/preview` (фиксированного кода нет).
6. Пополнение для тестов: Helper в UI (клик по логотипу) или `POST /admin/accounts/{id}/credit` (admin-токен) или `POST /helper/accounts/{id}/increase?amount=10000`.
7. Админ: логин `admin` / пароль `admin` → токен для админ-ручек.

Запуск тестов — в **backend/tests/README_TESTS.md**.

**Типичные коды ответов:** 200/201 — успех; 400 — ошибка бизнес-логики (см. `detail`); 401 — не авторизован; 403 — доступ запрещён; 404 — не найдено; 409 — конфликт (дубликат); 422 — ошибка валидации тела запроса.
