# ShlapaBank — учебный банковский API

Учебный проект для практики написания API-тестов. Backend (FastAPI) + статичный UI. Подготовка данных — только через API, без доступа к БД.

---

## Запуск

```powershell
docker compose up --build
```

- **Swagger:** http://localhost:8001/docs  
- **UI:** http://localhost:8001/ui/  
- **API base URL:** http://localhost:8001/api/v1  


---

## Блок 1. Health

### Зачем нужен

Проверка доступности сервиса. Используется для smoke-тестов и мониторинга.

### Требования

- Ручка публичная, авторизация не нужна.

### Ограничения

- Нет.

### Ручки

| Метод | Путь | Описание |
|-------|------|----------|
| GET | `/health` | Проверка доступности (без префикса /api/v1). Ответ: `{"status": "ok"}` |

---

## Блок 2. Авторизация (Auth)

### Зачем нужен

Регистрация новых пользователей и вход в систему. После успешного входа выдаётся JWT-токен, который нужен для доступа к защищённым ручкам.

### Требования

**Регистрация:**
- `login` — 6–20 символов. Разрешены только латиница (A–Z, a–z) и цифры (0–9). Запрещены: пробелы, кириллица, спецсимволы (_, -, @ и т.д.).
- `password` — 8–30 символов. Обязательно: минимум 1 строчная буква, 1 заглавная, 1 цифра, 1 спецсимвол. Без пробелов. Не должен совпадать с логином.

**Логин:**
- `login` — 1–20 символов.
- `password` — 1–100 символов.

### Ограничения

- Логин уникален. Повторная регистрация с тем же логином → 409.
- После 5 неудачных попыток входа пользователь блокируется. Дальнейший логин → 403 `user_blocked`.
- При успешном входе счётчик неудачных попыток сбрасывается.

### Ручки

| Метод | Путь | Описание |
|-------|------|----------|
| POST | `/auth/register` | Регистрация. Тело: `{"login": "...", "password": "..."}`. Ответ 201: объект пользователя (id, login, role, status и т.д.). |
| POST | `/auth/login` | Вход. Тело: `{"login": "...", "password": "..."}`. Ответ 200: `{"access_token": "...", "token_type": "bearer"}`. |

### Коды ошибок

| Код | detail | Когда |
|-----|--------|-------|
| 401 | `invalid_credentials` | Неверный логин или пароль |
| 403 | `user_blocked` | Пользователь заблокирован |
| 409 | `validation_error: login_not_unique` | Логин уже занят |
| 400 | `validation_error: password_equals_login` | Пароль совпадает с логином |
| 400 | `validation_error: weak_password` | Пароль не соответствует правилам |
| 400 | `validation_error: password_contains_space` | В пароле есть пробел |
| 422 | — | Ошибка валидации Pydantic (длина, формат, обязательные поля). Тело ответа содержит `detail` с описанием. |

---

## Блок 3. Аутентификация (JWT)

### Зачем нужен

Большинство ручек требуют авторизации. Токен, полученный при логине, передаётся в заголовке `Authorization`.

### Требования

- Заголовок: `Authorization: Bearer <access_token>`.
- Токен выдаётся при успешном `POST /auth/login`.

### Ограничения

- Токен имеет срок жизни (по умолчанию 60 минут, настраивается через `ACCESS_TOKEN_EXPIRE_MINUTES`).
- Истёкший или невалидный токен → 401 `invalid_token`.
- Заблокированный пользователь → 403 `user_blocked` (даже при валидном токене).

### Какие ручки защищены

Все, кроме `/health`, `/auth/register`, `/auth/login`. В Swagger защищённые ручки помечены замком; для вызова нужно нажать «Authorize» и ввести `Bearer <token>`.

---

## Блок 4. Профиль (Profile)

### Зачем нужен

Просмотр и обновление данных текущего пользователя: имя, фамилия, телефон, email, смена пароля.

### Требования

- Авторизация: Bearer-токен.
- Пользователь должен быть активен (не заблокирован).

**Обновление профиля (PUT):**
- `first_name`, `last_name` — только буквы (латиница и кириллица), 1–100 символов. Опционально.
- `phone` — формат `+7XXXXXXXXXX` (10 цифр после +7). Опционально.
- `email` — валидный email. Опционально.
- Смена пароля: обязательно оба поля — `current_password` и `new_password`. Правила для `new_password` те же, что при регистрации. Новый пароль не должен совпадать с текущим.

### Ограничения

- Телефон и email уникальны в системе. При совпадении с другим пользователем → 409.

### Ручки

| Метод | Путь | Описание |
|-------|------|----------|
| GET | `/profile` | Получить профиль текущего пользователя |
| PUT | `/profile` | Обновить профиль. Тело: частичный JSON (только нужные поля). |

### Коды ошибок

| Код | detail | Когда |
|-----|--------|-------|
| 409 | `validation_error: phone_not_unique` | Телефон уже используется |
| 409 | `validation_error: email_not_unique` | Email уже используется |
| 400 | `validation_error: password_change_requires_both_fields` | Указан только current или только new password |
| 401 | `invalid_current_password` | Неверный текущий пароль |
| 400 | `validation_error: password_reuse_not_allowed` | Новый пароль совпадает с текущим |

---

## Блок 5. Счета (Accounts)

### Зачем нужен

Управление банковскими счетами пользователя: список, создание, пополнение, закрытие.

### Требования

- Авторизация: Bearer-токен.
- Пользователь активен.

**Создание счёта (POST):**
- `account_type`: `DEBIT` или `SAVINGS`.
- `currency`: `RUB`, `USD`, `EUR`, `CNY`.

**Пополнение (POST `/{account_id}/topup`):**
- `amount` — положительное число (Decimal).
- `otp_code` — 4 цифры. Для тестов: `0000` или код из `GET /helper/otp/preview`.

### Ограничения

- Лимиты по количеству счетов: до 3 в RUB, до 3 в сумме по USD/EUR/CNY.
- Закрытие счёта возможно только при нулевом балансе.
- С накопительного счёта (SAVINGS) нельзя переводить — только с DEBIT.
- Номер счёта генерируется автоматически (маска по валюте: 2202… для RUB, 3202… для USD и т.д.).

### Ручки

| Метод | Путь | Описание |
|-------|------|----------|
| GET | `/accounts` | Список активных счетов пользователя |
| POST | `/accounts` | Создать счёт. Тело: `{"account_type": "DEBIT", "currency": "RUB"}` |
| DELETE | `/accounts/{account_id}` | Закрыть счёт (баланс должен быть 0) |
| POST | `/accounts/{account_id}/topup` | Пополнить счёт. Тело: `{"amount": "1000.00", "otp_code": "0000"}` |

### Коды ошибок

| Код | detail | Когда |
|-----|--------|-------|
| 400 | `account_limit_exceeded` | Превышен лимит счетов по валюте |
| 404 | `not_found` | Счёт не найден или не принадлежит пользователю |
| 400 | `account_already_closed` | Счёт уже закрыт |
| 400 | `account_close_requires_zero_balance` | Закрытие при ненулевом балансе |
| 400 | `invalid_otp_code` | Неверный OTP |
| 400 | `amount_must_be_positive` | Сумма ≤ 0 |
| 404 | `account_not_found` | Счёт не найден при topup |

---

## Блок 6. Переводы (Transfers)

### Зачем нужен

Переводы между счетами (своими и чужим по номеру счёта/телефона), обмен валют. Все операции с деньгами требуют OTP.

### Требования

- Авторизация: Bearer-токен.
- Пользователь активен.
- OTP: 4 цифры. Для тестов — `0000` или из `GET /helper/otp/preview`.

### Ограничения

**Лимиты (в рублёвом эквиваленте):**
- Разовая операция: 10–300 000 ₽.
- Суточный лимит на пользователя: 1 000 000 ₽.
- Курсы к RUB фиксированы (RUB=1, USD≈95, EUR≈105, CNY≈13.5).

**Правила:**
- Счёт списания — только DEBIT, активный.
- Перевод между счетами — только в одной валюте.
- Обмен — только между счетами в разных валютах.
- Перевод по телефону: получатель в нашем банке — зачисление на его DEBIT-счёт в той же валюте; во внешний банк — списание без зачисления (симуляция).

### Ручки

| Метод | Путь | Описание |
|-------|------|----------|
| GET | `/transfers/rates` | Курсы валют к RUB |
| GET | `/transfers/daily-usage` | Остаток суточного лимита (для UI) |
| POST | `/transfers` | Перевод между своими счетами по ID. Тело: `from_account_id`, `to_account_id`, `amount`, `otp_code` |
| POST | `/transfers/by-account` | Перевод по номеру счёта получателя. Тело: `from_account_id`, `target_account_number`, `amount`, `otp_code` |
| GET | `/transfers/by-phone/check?phone=+7...` | Проверка: получатель в нашем банке или нет; список доступных банков |
| POST | `/transfers/by-phone` | Перевод по телефону. Тело: `from_account_id`, `phone`, `recipient_bank_id`, `amount`, `otp_code` |
| POST | `/transfers/exchange` | Обмен валют между своими счетами. Тело: `from_account_id`, `to_account_id`, `amount`, `otp_code` |

### Коды ошибок

| Код | detail | Когда |
|-----|--------|-------|
| 400 | `invalid_otp_code` | Неверный OTP |
| 400 | `transfer_same_account` | Откуда и куда — один счёт |
| 400 | `transfer_amount_too_small` | Сумма < 10 |
| 400 | `transfer_amount_exceeds_single_limit` | Сумма > 300 000 |
| 400 | `transfer_amount_exceeds_daily_limit` | Превышен суточный лимит |
| 404 | `account_not_found` | Счёт не найден |
| 403 | `forbidden_account_access` | Нет доступа к счёту |
| 400 | `account_inactive` | Счёт неактивен |
| 400 | `transfer_not_allowed_from_savings` | Списание с SAVINGS |
| 400 | `currency_mismatch` | Разные валюты (или одинаковые при обмене) |
| 400 | `insufficient_funds` | Недостаточно средств |
| 404 | `recipient_not_found_in_our_bank` | Получатель по телефону не найден |
| 400 | `recipient_has_no_suitable_account` | Нет подходящего DEBIT-счёта у получателя |
| 400 | `currency_not_supported_for_exchange` | Неподдерживаемая пара валют |

---

## Блок 7. Платежи (Payments)

### Зачем нужен

Оплата мобильной связи и услуг поставщиков (ЖКХ, интернет, образование, благотворительность). Все платежи — только с рублёвого счёта.

### Требования

- Авторизация: Bearer-токен.
- Пользователь активен.
- OTP: 4 цифры.

**Мобильная связь:**
- `operator` — из справочника `GET /payments/mobile/operators`.
- `phone` — формат `+7XXXXXXXXXX`.
- `amount` — 100–12 000 ₽.

**Поставщики:**
- `provider` — из справочника `GET /payments/vendor/providers`.
- `account_number` — только цифры, длина зависит от провайдера (10–22 символов, см. справочник).

### Ограничения

- Счёт списания — только RUB, активный.
- Мобильная связь: 100–12 000 ₽.
- Поставщики: 100–500 000 ₽.

### Ручки

| Метод | Путь | Описание |
|-------|------|----------|
| GET | `/payments/mobile/operators` | Справочник операторов и лимитов |
| GET | `/payments/vendor/providers` | Справочник поставщиков и длин лицевых счетов |
| POST | `/payments/mobile` | Оплата мобильной связи. Тело: `account_id`, `operator`, `phone`, `amount`, `otp_code` |
| POST | `/payments/vendor` | Оплата поставщику. Тело: `account_id`, `provider`, `account_number`, `amount`, `otp_code` |

### Коды ошибок

| Код | detail | Когда |
|-----|--------|-------|
| 400 | `invalid_otp_code` | Неверный OTP |
| 400 | `payment_operator_not_supported` | Оператор не из справочника |
| 400 | `payment_provider_not_supported` | Поставщик не из справочника |
| 400 | `payment_amount_out_of_range` | Сумма вне диапазона |
| 400 | `payment_requires_rub_account` | Счёт не в RUB |
| 400 | `payment_account_number_invalid_length` | Неверная длина лицевого счёта |
| 404 | `account_not_found` | Счёт не найден |
| 400 | `insufficient_funds` | Недостаточно средств |

---

## Блок 8. Транзакции (Transactions)

### Зачем нужен

История финансовых операций пользователя. Полезно для проверки, что после topup/transfer/payment создалась запись с ожидаемыми полями.

### Требования

- Авторизация: Bearer-токен.
- Пользователь активен.

### Ограничения

- Возвращаются только транзакции, инициированные пользователем или затрагивающие его счета.

### Ручки

| Метод | Путь | Описание |
|-------|------|----------|
| GET | `/transactions` | История операций пользователя. Сортировка по дате (новые первые). |

**Типы транзакций:** `TOPUP`, `TRANSFER`, `PAYMENT`.  
**Поле `description`:** `admin_credit`, `self_topup`, `p2p_transfer`, `p2p_transfer_by_account`, `p2p_transfer_by_phone`, `p2p_by_phone_external:...`, `fx_exchange:...`, `mobile:...`, `vendor:...`.

---

## Блок 9. Настройки (Settings)

### Зачем нужен

Пользовательские настройки UI (тема, язык, уведомления). В MVP — фиксированный ответ.

### Требования

- Авторизация: Bearer-токен.

### Ручки

| Метод | Путь | Описание |
|-------|------|----------|
| GET | `/settings` | Настройки. Ответ: `theme`, `language`, `notificationsEnabled`. |

---

## Блок 10. Админ (Admin)

### Зачем нужен

Управление пользователями и счетами от имени администратора. Нужен для подготовки данных в тестах (блокировка, пополнение чужих счетов).

### Требования

- Авторизация: Bearer-токен пользователя с ролью `ADMIN`.
- Дефолтный админ: `admin` / `admin` (если не задано в `.env`).

### Ограничения

- Только роль ADMIN. Клиент → 403 `forbidden`.
- Банки для перевода по телефону: 0–5 внешних банков на пользователя. Наш банк в список не включается.

### Ручки

| Метод | Путь | Описание |
|-------|------|----------|
| GET | `/admin/users` | Список всех пользователей |
| POST | `/admin/users/{user_id}/block` | Заблокировать пользователя |
| POST | `/admin/users/{user_id}/unblock` | Разблокировать пользователя |
| POST | `/admin/accounts/{account_id}/credit` | Пополнить счёт от имени админа. Тело: `{"amount": "10000.00", "otp_code": "0000"}` |
| GET | `/admin/transactions` | Все транзакции системы |
| GET | `/admin/users/{user_id}/banks` | Список банков для перевода по телефону у пользователя |
| PUT | `/admin/users/{user_id}/banks` | Изменить банки. Тело: `{"bank_codes": ["alpha", "tinkoff"]}`. Только коды внешних банков. |

### Коды ошибок

| Код | detail | Когда |
|-----|--------|-------|
| 404 | `not_found` | Пользователь не найден |
| 404 | `account_not_found` | Счёт не найден |
| 400 | `invalid_otp_code` | Неверный OTP |
| 400 | `amount_must_be_positive` | Сумма ≤ 0 |
| 400 | `invalid_bank_codes: ...` | Указан наш банк или несуществующий |
| 400 | `max_5_banks_allowed` | Больше 5 банков |

---

## Блок 11. Helper

### Зачем нужен

Вспомогательные ручки для подготовки данных в тестах: получение OTP, изменение баланса без OTP и без создания транзакций. В UI — «читерская шляпа» (клик по логотипу) для быстрого изменения баланса.

### Требования

- Авторизация: Bearer-токен.
- Пользователь активен.
- Работа только со своими активными счетами.

### Ограничения

- Транзакции не создаются. Для «настоящего» пополнения используйте `POST /accounts/{id}/topup`.
- OTP из `otp/preview` живёт 5 минут и привязан к пользователю.

### Ручки

| Метод | Путь | Описание |
|-------|------|----------|
| GET | `/helper/otp/preview` | Получить OTP для операций. Ответ: `otp`, `ttlSeconds`, `message`. |
| POST | `/helper/accounts/{account_id}/increase?amount=...` | Увеличить баланс на amount |
| POST | `/helper/accounts/{account_id}/decrease?amount=...` | Уменьшить баланс на amount |
| POST | `/helper/accounts/{account_id}/zero` | Обнулить баланс |

### Коды ошибок

| Код | detail | Когда |
|-----|--------|-------|
| 404 | `account_not_found` | Счёт не найден или не свой |
| 400 | `account_inactive` | Счёт закрыт |
| 400 | `insufficient_funds` | Недостаточно средств при decrease |

---

## Подготовка к API-тестам

1. Запустить сервер: `docker compose up --build`.
2. Регистрация: `POST /auth/register` → получить пользователя.
3. Логин: `POST /auth/login` → получить `access_token`.
4. Дальнейшие запросы: заголовок `Authorization: Bearer <access_token>`.
5. OTP: использовать `0000` или `GET /helper/otp/preview`.
6. Пополнение для тестов: `POST /helper/accounts/{id}/increase?amount=10000` или `POST /admin/accounts/{id}/credit` (нужен admin-токен).
7. Админ: логин `admin` / `admin` → токен для админ-ручек.

Детальные сценарии — в **TEST_SCENARIOS.md**. Запуск тестов — в **backend/tests/README_TESTS.md**.

**Типичные коды ответов:** 200/201 — успех; 400 — ошибка бизнес-логики (см. `detail`); 401 — не авторизован; 403 — доступ запрещён; 404 — не найдено; 409 — конфликт (дубликат); 422 — ошибка валидации тела запроса.
