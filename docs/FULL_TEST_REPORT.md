# Полный отчёт тестирования API и UI ShlapaBank

**Дата:** 28 февраля 2025  
**Источники:** README.md (бизнес-требования), исходный код backend и ui-mockup

---

## 1. Методология тестирования

### 1.1 Тестирование по README (без исходного кода)

Проверка соответствия системы 12 блокам бизнес-требований из README, опираясь только на описание ожидаемого поведения.

### 1.2 Тестирование с анализом исходного кода

Сопоставление реализации (backend, ui-mockup) с требованиями README, выявление расхождений и пропусков.

### 1.3 Подготовка клиентских данных через API

Оценка возможности полностью подготовить тестовые сценарии только через API (без прямого доступа к БД или UI).

---

## 2. Сводка по блокам README

| Блок | Название | API реализован | UI реализован | Готовность |
|------|----------|----------------|---------------|------------|
| 1 | Health | ✅ | — | ✅ |
| 2 | Helper | ✅ | ✅ | ✅ |
| 3 | Admin | ✅ | — | ✅ |
| 4 | Auth | ✅ | ✅ | ✅ |
| 5 | Сессия | ✅ | ✅ | ✅ |
| 6 | Profile | ✅ | ✅ | ✅ |
| 7 | Accounts | ✅ | ✅ | ✅ |
| 8 | Transfers | ✅ | ✅ | ✅ |
| 9 | Payments | ✅ | ✅ | ✅ |
| 10 | Statistics | ❌ (клиент) | ✅ | ⚠️ |
| 11 | Transactions | ✅ | ✅ | ✅ |
| 12 | Receipt | ❌ (клиент) | ✅ | ⚠️ |

---

## 3. Детальный анализ по блокам

### Блок 1. Health

**Требования:** Проверка доступности без авторизации.

**API:** `GET /api/v1/health` — реализован, возвращает статус.

**Вывод:** ✅ Полностью соответствует README.

---

### Блок 2. Helper

**Требования:** OTP preview, пополнение/списание/обнуление, админ может пополнять любой счёт с purpose=salary.

**API:**
- `GET /helper/otp/preview` — OTP
- `GET /helper/accounts` — список счетов (админ — все, клиент — свои)
- `POST /helper/accounts/{id}/increase?amount=&purpose=` — пополнение (salary только админ)
- `POST /helper/accounts/{id}/decrease?amount=` — списание
- `POST /helper/accounts/{id}/zero` — обнуление
- `POST /helper/clear-browser` — инструкция очистки кеша

**Вывод:** ✅ Полностью соответствует README. Подготовка данных через API возможна.

---

### Блок 3. Admin

**Требования README:**
- Список пользователей
- Блокировка/разблокировка
- Удаление пользователей
- Просмотр и пополнение счетов
- Просмотр транзакций
- Настройка банков для перевода по телефону (0–5 банков)

**Реализация:**
- ✅ Просмотр счетов: `GET /helper/accounts` (админ видит все счета с owner_login)
- ✅ Пополнение любого счёта: `POST /helper/accounts/{id}/increase?purpose=salary`
- ✅ Список пользователей: `GET /admin/users`
- ✅ Блокировка/разблокировка: `POST /admin/users/{id}/block`, `POST /admin/users/{id}/unblock`
- ✅ Удаление пользователей: `DELETE /admin/users/{id}` (кроме администратора по умолчанию)
- ✅ Просмотр транзакций пользователя: `GET /admin/users/{id}/transactions`
- ✅ Настройка банков пользователя: `GET /admin/users/{id}/banks`, `PUT /admin/users/{id}/banks` (0–5 внешних банков)

**Вывод:** ✅ Блок Admin полностью реализован через API.

---

### Блок 4. Auth

**Требования:** Регистрация, вход, валидация логина/пароля, блокировка после 5 неудачных попыток.

**API:**
- `POST /auth/register` — регистрация
- `POST /auth/login` — вход

**Вывод:** ✅ Регистрация и вход реализованы. Блокировка после 5 попыток — в коде (security.py), но разблокировать можно только через отсутствующий Admin API.

---

### Блок 5. Сессия

**Требования:** Срок действия 60 мин, защита операций, запрет для заблокированных.

**Реализация:** JWT, проверка `require_active_user`, проверка `user_blocked`.

**Вывод:** ✅ Соответствует README.

---

### Блок 6. Profile

**Требования:** Имя, фамилия, телефон, email, смена пароля.

**API:** `GET /profile`, `PUT /profile` — реализованы.

**Вывод:** ✅ Соответствует README.

---

### Блок 7. Accounts

**Требования:** Список, создание (DEBIT/SAVINGS, RUB/USD/EUR/CNY), закрытие при нулевом балансе, пополнение с OTP.

**API:**
- `GET /accounts`
- `POST /accounts` (account_type, currency)
- `DELETE /accounts/{id}`
- `POST /accounts/{id}/topup` (amount, otp_code, purpose)

**Вывод:** ✅ Соответствует README. Лимиты (3 RUB, 3 FX) реализованы.

---

### Блок 8. Transfers

**Требования:** Между своими, по номеру счёта, по телефону, обмен валют. Лимиты 10–300k, суточные лимиты.

**API:**
- `POST /transfers` — между своими
- `POST /transfers/by-account` — по номеру счёта
- `GET /transfers/by-phone/check` — проверка получателя по телефону
- `POST /transfers/by-phone` — перевод по телефону
- `POST /transfers/exchange` — обмен валют
- `GET /transfers/rates`
- `GET /transfers/daily-usage`

**Вывод:** ✅ Соответствует README.

---

### Блок 9. Payments

**Требования:** Мобильная связь (100–12k ₽), поставщики (100–500k ₽), OTP.

**API:**
- `GET /payments/mobile/operators` — справочник операторов
- `POST /payments/mobile` — оплата мобильной связи
- `GET /payments/vendor/providers` — справочник поставщиков
- `POST /payments/vendor` — оплата поставщику

**Вывод:** ✅ Соответствует README.

---

### Блок 10. Statistics

**Требования:** Доходы и расходы по валютам на главной странице.

**Реализация:** Нет отдельного API. Статистика считается на клиенте в `dashboard.js` по данным `GET /transactions`.

**Вывод:** ⚠️ Требования выполняются через UI, но отдельного Statistics API нет. Для подготовки данных достаточно транзакций.

---

### Блок 11. Transactions

**Требования:** История операций, сортировка по дате.

**API:** `GET /transactions` — возвращает все транзакции пользователя.

**Вывод:** ✅ Соответствует README.

---

### Блок 12. Receipt (Чек)

**Требования:** Сохранение чека (HTML/PDF) по операции.

**Реализация:** Нет API. Чек формируется на клиенте в `dashboard.js` (downloadReceipt) из данных транзакции.

**Вывод:** ⚠️ Функция есть в UI, backend не участвует.

---

## 4. Подготовка клиентских данных через API

### 4.1 Что можно подготовить полностью через API

| Сценарий | API-подготовка |
|----------|----------------|
| Регистрация и вход | `POST /auth/register`, `POST /auth/login` |
| Профиль (имя, телефон, email) | `PUT /profile` |
| Счета (DEBIT/SAVINGS, валюты) | `POST /accounts` |
| Пополнение счёта | `POST /helper/accounts/{id}/increase` или `POST /accounts/{id}/topup` с OTP |
| Переводы (свои, по счёту, по телефону, обмен) | `POST /transfers/*` с OTP |
| Платежи (mobile, vendor) | `POST /payments/mobile`, `POST /payments/vendor` с OTP |
| История операций | Создаётся автоматически при операциях |
| Статистика | Вычисляется на клиенте из `/transactions` |
| Чек | Генерируется на клиенте из данных транзакции |

### 4.2 Что нельзя подготовить через API

Все сценарии Admin теперь доступны через API. Ограничений нет.

### 4.3 Рекомендации для тестов

1. **Автотесты** (`backend/tests/`) используют только API: регистрация, Helper, OTP, операции. Это достаточная подготовка для большинства сценариев.
2. **Admin-сценарии** — полностью поддерживаются через `GET/POST/DELETE /admin/users/*`.
3. **Статистика и чек** — клиентские функции; подготовка через создание транзакций через API достаточна.

---

## 5. Существующие автотесты

**Расположение:** `backend/tests/`

| Файл | Покрытие |
|------|----------|
| `test_auth.py` | Регистрация, вход, валидация |
| `test_accounts.py` | Счета, topup, закрытие, лимиты |
| `test_transfers.py` | Переводы, обмен, лимиты |
| `test_payments.py` | Mobile, vendor, ошибки |
| `test_helper.py` | OTP, increase, decrease, zero |
| `test_profile.py` | Профиль, смена пароля |
| `test_transactions.py` | Список транзакций |
| `test_catalog.py` | Settings |
| `test_statistics.py` | Статистика (через транзакции) |
| `test_admin.py` | Admin: список, блокировка, удаление, банки, транзакции |

**Запуск:** `pytest backend/tests/ -v` (при поднятом `docker compose up`).

**Примечание:** В `test_statistics.py` исправлено использование `operators`: API возвращает список строк (например, `["Babline","MTSha",...]`), а не объекты с полем `code`.

---

## 6. Выводы

1. **API** покрывает блоки 1, 2, 4–9, 11. Блок 3 (Admin) реализован частично; блоки 10 и 12 реализованы на клиенте.
2. **Подготовка данных через API** возможна для всех сценариев, кроме Admin (список пользователей, блокировка, удаление, настройка банков).
3. **UI** реализует все описанные в README функции; статистика и чек работают на клиенте без отдельного backend API.
4. **Admin API** реализован: список пользователей, блокировка/разблокировка, удаление, настройка банков, просмотр транзакций.
