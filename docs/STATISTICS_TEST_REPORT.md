# Отчёт о тестировании блока «Статистика»

## Цель

Проверить корректность отображения доходов и расходов в блоке «Статистика» на главной странице. Все типы операций должны учитываться в соответствующих полосках с разбивкой по валютам (RUB, USD, EUR, CNY).

## Исправления

### 1. Классификация транзакций (getTransactionMeta)

**Проблема:** Переводы по телефону (`p2p_transfer_by_phone`) и внешние переводы (`p2p_by_phone_external`) ошибочно определялись как `transfer-own` вместо `transfer-out`, из‑за чего входящие переводы не попадали в доходы, а исходящие — в расходы.

**Исправление:** Обновлена логика определения типа:
- `fx_exchange` → fx (обмен валют)
- `p2p_transfer` (exact) → transfer-own (между своими счетами)
- `p2p_transfer_by_account`, `p2p_transfer_by_phone`, `p2p_by_phone_external` → transfer-out

### 2. Пополнение через Helper (шляпу) — теперь учитывается в статистике

**Пополнение через Helper** (через шляпу) **создаёт транзакцию** и отображается в статистике:
- Без типа дохода → `helper_topup` (Пополнение)
- С типом «Подарок» → `helper_topup:gift`
- С типом «Зарплата» → `admin_credit` (только для администратора)

**Зарплату** может начислить только администратор. Клиент не может выбрать «Зарплата» в шляпе — опция скрыта.

**Администратор** в шляпе видит все счета в системе и может начислить зарплату на любой счёт.

## Типы операций и их отображение

| Тип операции | Источник | Полоска | Валюта |
|--------------|----------|---------|--------|
| Пополнение (self_topup) | API topup | Доход | Из транзакции |
| Пополнение (self_topup:salary) | API topup + purpose | Доход | Из транзакции |
| Пополнение (self_topup:gift) | API topup + purpose | Доход | Из транзакции |
| Пополнение (helper_topup) | Шляпа | Доход | Из транзакции |
| Пополнение (helper_topup:gift) | Шляпа + тип «Подарок» | Доход | Из транзакции |
| Зарплата (admin_credit) | Шляпа + тип «Зарплата» (только админ) | Доход | Из транзакции |
| Входящий перевод (p2p_transfer_by_account/phone) | Перевод по счёту/телефону | Доход | Из транзакции |
| Платёж (mobile, vendor) | API payments | Платежи, Общий расход | RUB |
| Исходящий перевод (p2p_transfer_by_account/phone) | Перевод по счёту/телефону | Переводы, Общий расход | Из транзакции |
| Обмен валют (fx_exchange) | API exchange | Общий расход | Валюта списания |
| Перевод между своими (p2p_transfer) | API transfers | — | Не учитывается |

## Структура полосок

1. **Доход** — полоска по валютам (RUB, USD, EUR, CNY), сегменты пропорциональны сумме.
2. **Расход** — полоска по валютам (платежи + переводы + обмен).

Обе полоски всегда отображаются. При отсутствии данных показывается серая полоска и «—» в легенде.

## Цвета валют

| Валюта | Цвет |
|--------|------|
| RUB | #dc2626 (красный) |
| USD | #2563eb (синий) |
| EUR | #059669 (зелёный) |
| CNY | #d97706 (оранжевый) |

## Тесты

Запуск автотестов:

```bash
cd backend
pytest tests/test_statistics.py -v
```

Покрытие:

- `test_statistics_income_topup_rub` — доход по пополнению RUB
- `test_statistics_income_topup_usd` — доход по пополнению USD
- `test_statistics_income_topup_salary` — доход с purpose=salary
- `test_statistics_expense_payment` — платежи (mobile)
- `test_statistics_expense_transfer` — перевод по номеру счёта
- `test_statistics_expense_fx` — обмен валют
- `test_statistics_transfer_own_not_counted` — перевод между своими не учитывается

## Рекомендации

1. Для проверки доходов в статистике использовать **пополнение через API** (с OTP), а не через Helper.
2. Для подготовки тестовых данных через Helper — создавать затем операции через API (пополнение, переводы, платежи), чтобы они отображались в статистике.
