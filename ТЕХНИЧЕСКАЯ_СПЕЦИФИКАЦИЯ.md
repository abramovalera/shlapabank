# Техническая спецификация. ShlapaBank (учебный проект)

| Статус документа | DRAFT |
|------------------|--------|
| Версия           | 0.1    |

---

## История изменений

| Версия | Дата       | Комментарий                    |
|--------|------------|---------------------------------|
| 0.1    | 01.03.2026 | Первая версия ТС по всем фичам |

---

## Оглавление

1. [Общие сведения](#1-общие-сведения)
2. [Health — проверка доступности](#2-health--проверка-доступности)
3. [Auth — регистрация и вход](#3-auth--регистрация-и-вход)
4. [Сессия и авторизация](#4-сессия-и-авторизация)
5. [Profile — профиль пользователя](#5-profile--профиль-пользователя)
6. [Accounts — счета](#6-accounts--счета)
7. [Helper — вспомогательные операции](#7-helper--вспомогательные-операции)
8. [Admin — администрирование](#8-admin--администрирование)
9. [Transfers — переводы](#9-transfers--переводы)
10. [Payments — платежи](#10-payments--платежи)
11. [Transactions — история операций](#11-transactions--история-операций)
12. [Receipt — чек операции](#12-receipt--чек-операции)
13. [Settings — настройки](#13-settings--настройки)
14. [Модели данных и константы](#14-модели-данных-и-константы)
15. [Разбор ответов API](#15-разбор-ответов-api)

---

## 1. Общие сведения

### 1.1. Цель документа

Описание всех фич приложения ShlapaBank в формате технической спецификации: цели, техническое решение, поля запросов/ответов, коды ошибок, логика и смена статусов — достаточно для реализации такого же приложения.

### 1.2. Базовый URL и авторизация

- Базовый префикс API: `/api/v1`.
- Запросы к защищённым ручкам: заголовок `Authorization: Bearer <access_token>`.
- Токен выдаётся при успешном входе (POST `/api/v1/auth/login`). В теле ответа поле `access_token`.
- Не требуют токена: `GET /api/v1/health`, `POST /api/v1/auth/register`, `POST /api/v1/auth/login`.

### 1.3. Формат ошибок

При ошибке API возвращает JSON с полем `detail` (строка или массив объектов валидации). В таблицах по каждой ручке указаны значения `detail` и HTTP-код.

---

## 2. Health — проверка доступности

### 2.1. Цель

Проверить, что сервис запущен и отвечает. Используется мониторингом и тестами.

### 2.2. Техническое решение

Один эндпоинт без авторизации. Не обращается к БД.

### 2.3. Реализуемые API

| Метод | Путь              | Авторизация | Описание           |
|-------|-------------------|-------------|--------------------|
| GET   | `/api/v1/health`  | Нет         | Проверка доступности |

**Ответ 200 OK**

| Поле     | Тип    | Описание   |
|----------|--------|------------|
| `status` | string | Всегда `"ok"` |

**Пример тела ответа:** `{"status": "ok"}`

---

## 3. Auth — регистрация и вход

### 3.1. Цель

Регистрация нового пользователя (логин, пароль) и вход по логину/паролю с выдачей токена доступа.

### 3.2. Техническое решение

- Регистрация: проверка правил пароля и уникальности логина; хеш пароля (bcrypt); создание пользователя; назначение 0–5 случайных внешних банков (UserBank). Статус пользователя при создании — ACTIVE.
- Вход: поиск пользователя по логину; проверка пароля; при неверном пароле — увеличение счётчика `failed_login_attempts`, при достижении порога (5) — смена статуса на BLOCKED; при успешном пароле — сброс счётчика в 0 и выдача JWT с `sub=user_id`, срок жизни из конфига (по умолчанию 60 минут). В ответе — токен и роль (ADMIN/CLIENT).
- Срок действия токена не настраивается, по умолчанию 60 минут. Рекомендуемая проверка при входе: если у пользователя статус BLOCKED — до проверки пароля возвращать 403 и `detail=user_blocked`, иначе клиент с правильным паролем сможет войти после блокировки.

### 3.3. Валидация (регистрация и смена пароля)

| Правило              | Ошибка (detail)                         |
|----------------------|----------------------------------------|
| Логин от 6 до 20 символов включительно, только A–Z, a–z, 0–9 | 422 (валидация)                  |
| Пароль от 8 до 30 символов включительно | 422                                    |
| Пароль совпадает с логином | `validation_error: password_equals_login` |
| В пароле есть пробел | `validation_error: password_contains_space` |
| Нет строчной/заглавной/цифры/спецсимвола | `validation_error: weak_password` |
| Логин занят          | `validation_error: login_not_unique` (409) |

### 3.4. Реализуемые API

**POST `/api/v1/auth/register`** — регистрация.

| Поле      | Тип   | Обязательное | Ограничения                          |
|-----------|-------|--------------|--------------------------------------|
| `login`   | string| Да           | 6–20, только латиница и цифры        |
| `password`| string| Да           | 8–30, правила см. выше               |

Ответ 201: тело — объект пользователя (UserPublic).  
Ответ 409: `detail`: `validation_error: login_not_unique`.  
Ответ 400: ошибки валидации пароля (см. таблицу выше).

**POST `/api/v1/auth/login`** — вход.

| Поле      | Тип   | Обязательное | Ограничения   |
|-----------|-------|--------------|---------------|
| `login`   | string| Да           | 1–20          |
| `password`| string| Да           | 1–100         |

Ответ 200: тело — TokenResponse.

| Поле           | Тип   | Описание                    |
|----------------|-------|-----------------------------|
| `access_token` | string| JWT для заголовка Authorization |
| `token_type`   | string| `"bearer"`                  |
| `role`         | string| `ADMIN` или `CLIENT`        |

Ответ 401: `detail`: `invalid_credentials` (неверный логин или пароль; при неверном пароле счётчик неудачных попыток увеличивается; при 5 подряд пользователь переводится в BLOCKED).  
Рекомендуемо: ответ 403 с `detail`: `user_blocked`, если у пользователя статус BLOCKED (проверка до проверки пароля).

---

## 4. Сессия и авторизация

### 4.1. Цель

Защита ручек: проверка JWT и при необходимости проверка, что пользователь не заблокирован.

### 4.2. Техническое решение

- Зависимость «текущий пользователь»: из заголовка `Authorization: Bearer <token>` извлекается JWT, проверяется подпись и срок действия, из `sub` берётся `user_id`, по нему загружается User из БД. Если токена нет или он невалиден — 401, `detail=invalid_token`.
- Зависимость «активный пользователь»: поверх «текущий пользователь» проверяется `user.status != BLOCKED`; иначе 403, `detail=user_blocked`.
- Зависимость «админ»: поверх «активный пользователь» проверяется `user.role == ADMIN`; иначе 403, `detail=forbidden`.

Все ручки, кроме health, register, login, используют либо «активный пользователь», либо «админ».

---

## 5. Profile — профиль пользователя

### 5.1. Цель

Просмотр и обновление данных текущего пользователя: имя, фамилия, телефон, email, смена пароля.

### 5.2. Техническое решение

- GET: возврат текущего пользователя (UserPublic). Заблокированный может читать профиль (используется зависимость «текущий пользователь» без проверки BLOCKED).
- PUT: обновление полей; проверки уникальности phone и email (кроме своего); смена пароля только при указании текущего и нового, с проверкой правил и что новый не совпадает с текущим. Используется зависимость «активный пользователь».

### 5.3. Валидация профиля

| Поле          | Ограничения                          |
|---------------|--------------------------------------|
| first_name    | 1–100 символов, только буквы (латиница/кириллица), необязательно |
| last_name     | то же                               |
| phone         | формат +7 и 10 цифр; нормализация через normalize_phone; необязательно |
| email         | валидный email; необязательно        |
| current_password, new_password | по 8–30; правила как при регистрации |

Уникальность: phone и email не должны совпадать с другим пользователем. При смене пароля оба поля обязательны или оба пустые.

### 5.4. Реализуемые API

**GET `/api/v1/profile`** — получить профиль.  
Ответ 200: UserPublic (id, login, email, role, status, first_name, last_name, phone).  
Ответ 401: невалидный/отсутствующий токен.

**PUT `/api/v1/profile`** — обновить профиль.

Тело (все поля опциональны): first_name, last_name, phone, email, current_password, new_password.

Ответ 200: UserPublic (обновлённый).  
Ответ 400: `validation_error: password_change_requires_both_fields`, `validation_error: password_reuse_not_allowed`.  
Ответ 401: `invalid_current_password`.  
Ответ 409: `validation_error: phone_not_unique`, `validation_error: email_not_unique`.

---

## 6. Accounts — счета

### 6.1. Цель

Список активных счетов пользователя, создание счёта, закрытие счёта, пополнение с OTP, установка приоритетных счетов по валютам.

### 6.2. Техническое решение

- Номер счёта: 16 цифр, префикс по валюте (RUB 2202, USD 3202, EUR 4202, CNY 5202), остальное случайные цифры. Уникальность в БД.
- Лимиты: не более 3 счетов в RUB; не более 3 счетов суммарно по всем иностранным валютам (USD, EUR, CNY вместе). Закрытие только при balance = 0 (is_active → false). Пополнение — с проверкой OTP и amount > 0; создаётся транзакция TOPUP.
- Приоритетные счета: поле is_primary; пользователь передаёт список account_ids (до 4); у указанных is_primary=true, у остальных своих — false.

### 6.3. Реализуемые API

**GET `/api/v1/accounts`**  
Ответ 200: массив AccountPublic. Только счета текущего пользователя с is_active=true.

**POST `/api/v1/accounts`** — открыть счёт.

Тело: `account_type` (DEBIT | SAVINGS), `currency` (RUB | USD | EUR | CNY).

Ответ 201: AccountPublic.  
Ответ 400: `account_limit_exceeded`.

**PUT `/api/v1/accounts/primary`**  
Тело: `account_ids` — массив до 4 id. Все id должны принадлежать текущему пользователю и активным счетам.  
Ответ 200: `{"status":"ok","detail":"primary_accounts_updated"}`.  
Ответ 404: `account_not_found` (если один из id не свой).

**DELETE `/api/v1/accounts/{account_id}`** — закрыть счёт.  
Ответ 200: `{"status":"ok","detail":"account_closed"}`.  
Ответ 404: `account_not_found`. Ответ 400: `account_already_closed`, `account_close_requires_zero_balance`.

**POST `/api/v1/accounts/{account_id}/topup`** — пополнение с OTP.

Тело: `amount` (Decimal > 0), `otp_code` (4 цифры), `purpose` (опционально, например salary, gift; строка из строчных букв и подчёркивания).

Ответ 201: TransactionPublic (операция TOPUP).  
Ответ 400: `invalid_otp_code`, `amount_must_be_positive`.  
Ответ 404: `account_not_found`.

Формат AccountPublic и TransactionPublic — см. раздел 14.

---

## 7. Helper — вспомогательные операции

### 7.1. Цель

Подготовка тестовых данных: получение OTP, пополнение/списание/обнуление баланса без OTP (для тестов и «шляпы» в UI).

### 7.2. Техническое решение

- OTP: хранится в памяти процесса, один код на user_id, срок жизни 1 минута. Либо в конфиге задаётся фиксированный operation_otp_code — тогда он принимается без проверки хранилища. После успешной проверки код одноразовый (удаляется).
- Пополнение (increase): создаётся транзакция TOPUP (helper_topup, admin_credit или helper_topup:gift в зависимости от purpose). Лимит баланса и суммы: 12 знаков до запятой (999999999999.99). Purpose salary — только для роли ADMIN.
- Списание (decrease) и обнуление (zero): записей в историю не создают. Клиент только свои счета; админ — любой счёт (для increase).

### 7.3. Реализуемые API

**GET `/api/v1/helper/otp/preview`**  
Ответ 200: `userId`, `otp` (4 цифры), `ttlSeconds`, `message`.

**GET `/api/v1/helper/accounts`**  
Ответ 200: массив счетов. Клиент — только свои активные (формат как AccountPublic); админ — все активные + поле owner_login.

**POST `/api/v1/helper/accounts/{account_id}/increase`**  
Query: `amount` (обязательно, > 0), `purpose` (опционально: salary | gift | пусто).  
Ответ 200: AccountPublic.  
Ответ 400: `amount_too_large`, `account_not_found`, `account_inactive`, `insufficient_funds` (для decrease).  
Ответ 403: `salary_credit_admin_only`, `forbidden_account_access`.

**POST `/api/v1/helper/accounts/{account_id}/decrease`**  
Query: `amount` (> 0). Списание без создания транзакции.  
Ответ 200: AccountPublic.  
Ответ 400: `insufficient_funds`, `account_not_found`, `account_inactive`.

**POST `/api/v1/helper/accounts/{account_id}/zero`**  
Обнуление баланса. Ответ 200: AccountPublic.

**POST `/api/v1/helper/clear-browser`**  
Ответ 200: `{"detail":"clear_browser","redirect":"/login"}`.

---

## 8. Admin — администрирование

### 8.1. Цель

Управление пользователями и настройками: список пользователей, блокировка/разблокировка, удаление, банки пользователя для переводов по телефону, просмотр транзакций пользователя, сброс БД к исходному состоянию.

### 8.2. Техническое решение

- Доступ только при role=ADMIN (и статус не BLOCKED). Дефолтный админ задаётся конфигом (login, email, password); его нельзя удалить и нельзя блокировать (при блокировке/удалении возвращается ошибка).
- Блокировка: user.status = BLOCKED. Разблокировка: user.status = ACTIVE, failed_login_attempts = 0.
- Банки пользователя: 0–5 записей UserBank; коды только из справочника внешних банков (наш банк в список передавать нельзя). При обновлении старые записи удаляются, добавляются переданные bank_codes.
- restore-initial-state: удаление всех Transaction, Account, UserBank, User; создание одного пользователя — дефолтный админ.

### 8.3. Реализуемые API

**GET `/api/v1/admin/users`**  
Ответ 200: массив UserPublic (все пользователи).

**POST `/api/v1/admin/users/{user_id}/block`**  
Ответ 200: UserPublic (обновлённый). Ответ 404: `user_not_found`. Ответ 400: `cannot_delete_admin` (для дефолтного админа).

**POST `/api/v1/admin/users/{user_id}/unblock`**  
Ответ 200: UserPublic. Ответ 404: `user_not_found`.

**DELETE `/api/v1/admin/users/{user_id}`**  
Ответ 200: `{"detail":"user_deleted"}`. Ответ 404: `user_not_found`. Ответ 400: `cannot_delete_admin`.

**GET `/api/v1/admin/users/{user_id}/banks`**  
Ответ 200: `{"bank_codes":["alpha","tinkoff",...]}`. Ответ 404: `user_not_found`.

**PUT `/api/v1/admin/users/{user_id}/banks`**  
Тело: `bank_codes` — массив до 5 строк (коды из справочника, без нашего банка).  
Ответ 200: `{"detail":"banks_updated","bank_codes":[...]}`.  
Ответ 400: `invalid_bank_codes` (указан наш банк или несуществующий), `bank_limit_exceeded` (больше 5 банков). Ответ 404: `user_not_found`.

**GET `/api/v1/admin/users/{user_id}/transactions`**  
Ответ 200: массив TransactionPublic (все транзакции пользователя: по инициатору или по его счетам). Ответ 404: `user_not_found`.

**POST `/api/v1/admin/restore-initial-state`**  
Ответ 200: `{"detail":"database_reset","message":"..."}`.

---

## 9. Transfers — переводы

### 9.1. Цель

Переводы между своими счетами, по номеру счёта (внутри банка или во внешний банк с комиссией), по телефону (внутри банка или во внешний с комиссией), обмен валют. Проверка счёта и проверка получателя по телефону.

### 9.2. Техническое решение

- Лимиты: разовая операция 10–300 000 в единицах валюты; суточный лимит по валюте (RUB 1 000 000, USD 10 000, EUR 9 500, CNY 70 000). Учитываются только переводы и обмен (не платежи). Перевод между своими счетами в суточный лимит не входит.
- Комиссии: перевод по номеру счёта во внешний банк — 5% от суммы; перевод по телефону во внешний банк — 2%. Списывается сумма + комиссия; проверка достаточности по total.
- OTP: обязателен для всех операций, кроме перевода между своими счетами (там otp_code опционально).
- Счёт списания: только DEBIT, is_active. С накопительного (SAVINGS) переводы запрещены.
- Обмен валют: разрешены любые пары из RUB, USD, EUR, CNY. Курсы захардкожены (RUB 1, USD 95, EUR 105, CNY 13.5 к RUB); конвертация через RUB. Учитывается в суточном лимите по валюте счёта списания.
- Приоритетный счёт получателя: при переводе по телефону внутри банка зачисление на расчётный счёт в той же валюте (при наличии is_primary — можно использовать его).

### 9.3. Реализуемые API

**POST `/api/v1/transfers`** — перевод между своими счетами.

Тело: `from_account_id`, `to_account_id`, `amount` (> 0), `otp_code` (опционально).

Ответ 201: TransactionPublic.  
Ответ 400: `invalid_otp_code`, `transfer_same_account`, `transfer_amount_too_small`, `transfer_amount_exceeds_single_limit`, `account_not_found`, `forbidden_account_access`, `account_inactive`, `currency_mismatch`, `insufficient_funds`, `transfer_not_allowed_from_savings`.

**GET `/api/v1/transfers/by-account/check`**  
Query: `target_account_number` (16 цифр).  
Ответ 200: `{"found": true|false, "masked": "••••1234"}`.

**POST `/api/v1/transfers/by-account`** — перевод по номеру счёта (счёт в нашем банке).  
Тело: `from_account_id`, `target_account_number` (16 цифр), `amount`, `otp_code`.  
Ответ 201: TransactionPublic. Ответ 400: как выше + `transfer_amount_exceeds_daily_limit`.

**POST `/api/v1/transfers/external-by-account`** — перевод на счёт в другом банке (комиссия 5%).  
Тело: то же, что by-account. Счёт не должен быть найден в нашем банке.  
Ответ 201: TransactionPublic (fee в money > 0). Ответ 400: `account_found_in_bank` (если счёт оказался в нашем банке), `invalid_account_number`, и остальные как выше.

*Ошибка `account_found_in_bank` при переводе по телефону:* когда пользователь выбрал внешний банк (`recipient_bank_id`), но номер телефона принадлежит клиенту нашего банка.

**GET `/api/v1/transfers/by-phone/check`**  
Query: `phone` (+7 и 10 цифр).  
Ответ 200: `{"inOurBank": true|false, "availableBanks": [{"id":"code","label":"Название"},...]}`. Если inOurBank — в списке наш банк + до 5 банков пользователя-получателя; иначе — все внешние банки из справочника.

**POST `/api/v1/transfers/by-phone`**  
Тело: `from_account_id`, `phone`, `amount`, `recipient_bank_id` (код банка из availableBanks), `otp_code`.  
Если recipient_bank_id = наш банк — зачисление получателю (по телефону) на расчётный счёт в той же валюте. Иначе — списание + комиссия 2%.  
Ответ 201: TransactionPublic.  
Ответ 400: `invalid_otp_code`, лимиты, `account_not_found`, `account_inactive`, `transfer_not_allowed_from_savings`, `insufficient_funds`, `recipient_not_found_in_our_bank`, `recipient_has_no_suitable_account`, `transfer_same_account`, `transfer_amount_exceeds_daily_limit`.

**POST `/api/v1/transfers/exchange`** — обмен валют между своими счетами.  
Тело: `from_account_id`, `to_account_id`, `amount`, `otp_code`. Валюты должны различаться; пары только через справочник курсов.  
Ответ 201: TransactionPublic.  
Ответ 400: `transfer_same_account`, `transfer_amount_too_small`, `account_not_found`, `forbidden_account_access`, `account_inactive`, `transfer_not_allowed_from_savings`, `currency_mismatch`, `currency_not_supported_for_exchange`, `insufficient_funds`, `transfer_amount_exceeds_daily_limit`.

**GET `/api/v1/transfers/daily-usage`**  
Ответ 200: `{"limits":{"perCurrency":[{"currency":"RUB","dailyLimit":"1000000.00","usedToday":"0.00","remaining":"1000000.00"},...]}}`.

**GET `/api/v1/transfers/rates`**  
Ответ 200: `{"userId": id, "base":"RUB", "toRub":{"RUB":"1","USD":"95",...}}`.

---

## 10. Payments — платежи

### 10.1. Цель

Оплата мобильной связи и поставщиков (ЖКХ, интернет, образование, благотворительность) с рублёвого счёта. Обязателен OTP.

### 10.2. Техническое решение

- Только счёт в валюте RUB, is_active. Список операторов и поставщиков захардкожен; длина лицевого счёта поставщика — по справочнику (строго).
- Мобильная связь: сумма 100–12 000 RUB. Поставщики: 100–500 000 RUB. Комиссия 0.

### 10.3. Справочники

Операторы: Babline, MTSha, MegaFun, TelePanda, YotaLike.  
Поставщики (имя и длина лицевого счёта): RostelCom+ 15, TV360 12, FiberNet 14, ZhKH-Service 20, UO-Gorod 18, DomComfort 22, GasEnergy 22, CityWater 18, UniEdu 16, EduCenter+ 16, GoodHands 10, KindKids 12.

### 10.4. Реализуемые API

**GET `/api/v1/payments/mobile/operators`**  
Ответ 200: `userId`, `operators` (массив строк), `amountRangeRub`: `{min, max}`.

**POST `/api/v1/payments/mobile`**  
Тело: `account_id`, `operator`, `phone` (+7 и 10 цифр), `amount`, `otp_code`.  
Ответ 201: TransactionPublic (type=PAYMENT, description вида mobile:Operator:phone).  
Ответ 400: `invalid_otp_code`, `payment_operator_not_supported`, `payment_amount_out_of_range`, `account_not_found`, `payment_requires_rub_account`, `insufficient_funds`.

**GET `/api/v1/payments/vendor/providers`**  
Ответ 200: `userId`, `providers`: `[{name, accountLength},...]`, `amountRangeRub`: `{min, max}`.

**POST `/api/v1/payments/vendor`**  
Тело: `account_id`, `provider`, `account_number` (только цифры, длина по провайдеру), `amount`, `otp_code`.  
Ответ 201: TransactionPublic (type=PAYMENT, description вида vendor:Provider:account_number).  
Ответ 400: `invalid_otp_code`, `payment_provider_not_supported`, `payment_account_number_invalid_length`, `payment_amount_out_of_range`, `account_not_found`, `payment_requires_rub_account`, `insufficient_funds`.

---

## 11. Transactions — история операций

### 11.1. Цель

Получение списка операций текущего пользователя: те, что он инициировал, или где участвуют его счета (входящие переводы и т.д.). Сортировка по дате создания (сначала новые).

### 11.2. Техническое решение

Выборка: initiated_by = current_user.id ИЛИ from_account_id IN (счета пользователя) ИЛИ to_account_id IN (счета пользователя). Пагинации в API нет — возвращаются все подходящие записи без ограничения по количеству; пагинация (5 + по 10) только в UI.

### 11.3. Реализуемые API

**GET `/api/v1/transactions`**  
Ответ 200: массив TransactionPublic (формат см. раздел 14).

---

## 12. Receipt — чек операции

### 12.1. Цель

Получение HTML-чека по операции для сохранения или печати. Доступ только к операциям из своей истории (те же правила, что и для списка транзакций).

### 12.2. Техническое решение

По transaction_id загружается транзакция; проверка доступа (инициатор или владелец from/to счёта). В чеке: заголовок, сумма (с учётом комиссии при наличии), дата/время, тип операции, счета списания/зачисления, детали по типу (оператор/телефон, поставщик/лицевой счёт, перевод/банк, пополнение/источник), номер операции и статус. Формат — HTML, Content-Type: text/html, при сохранении — Content-Disposition: attachment.

### 12.3. Реализуемые API

**GET `/api/v1/transactions/{transaction_id}/receipt`**  
Ответ 200: тело — HTML (Content-Type: text/html).  
Ответ 404: `not_found` (транзакция не найдена или операция не из своей истории — нет доступа).

---

## 13. Settings — настройки

### 13.1. Цель

Получение настроек интерфейса (тема, язык, уведомления). Значения могут быть константами.

### 13.2. Реализуемые API

**GET `/api/v1/settings`**  
Ответ 200: `{"theme":"LIGHT","language":"RU","notificationsEnabled":true}`.

---

## 14. Модели данных и константы

### 14.1. Сущности и статусы

**User**  
Поля: id, login (unique), email (unique, nullable), password_hash, role (CLIENT|ADMIN), status (ACTIVE|BLOCKED), failed_login_attempts, first_name, last_name, phone, created_at.  
Смена статуса: при 5 неудачных входах подряд status → BLOCKED; разблокировка админом → ACTIVE и сброс failed_login_attempts.

**Account**  
Поля: id, account_number (unique, 16 цифр), user_id, account_type (DEBIT|SAVINGS), currency (RUB|USD|EUR|CNY), balance (>= 0, Numeric(14,2)), is_active (default true), is_primary (default false), created_at.  
Смена состояния: закрытие счёта — is_active → false только при balance = 0.

**Transaction**  
Поля: id, from_account_id (nullable), to_account_id (nullable), type (TOPUP|TRANSFER|PAYMENT), amount, currency, status (COMPLETED|FAILED), initiated_by (user_id), description, fee (default 0), created_at.

**Bank** — справочник банков (code, label).  
**UserBank** — связь пользователя с банками для переводов по телефону (user_id, bank_code); до 5 записей на пользователя, только внешние банки.

### 14.2. Константы

- MIN_TRANSFER_AMOUNT = 10; MAX_TRANSFER_AMOUNT = 300 000.
- DAILY_TRANSFER_LIMIT: RUB 1 000 000, USD 10 000, EUR 9 500, CNY 70 000.
- FAILED_LOGIN_THRESHOLD = 5.
- OTP TTL = 1 минута. Код — 4 цифры.
- Комиссии: внешний перевод по счёту 5%, по телефону 2%.
- Курсы к RUB: RUB 1, USD 95, EUR 105, CNY 13.5.
- Лимит баланса и суммы операции: 999 999 999 999.99 (12 знаков до запятой, 2 после); применяется к сумме одной операции и к итоговому балансу счёта после операции.
- Счета: макс. 3 RUB, макс. 3 по иностранным валютам в сумме.
- Номер счёта: 16 цифр; префиксы RUB 2202, USD 3202, EUR 4202, CNY 5202.

### 14.3. Форматы ответов

**UserPublic:** id, login, email, role, status, first_name, last_name, phone (пустые строки для null first_name/last_name).

**AccountPublic:** id, account_number, account_type, currency, balance, is_primary.

**TransactionPublic:** id, type, money (объект), description, created_at, from_account_id, to_account_id, status.  
**money:** amount (строка, 2 знака), fee (строка), total (строка), currency (строка).

**TransferByAccountCheckResponse:** found (bool), masked (строка).  
**TransferByPhoneCheckResponse:** inOurBank (bool), availableBanks (массив {id, label}).  
**ActionResponse:** status ("ok"), detail (опционально).

### 14.4. Телефон

В API принимается и возвращается строка в формате `+79XXXXXXXXX` (12 символов). Нормализация: +7 и 10 цифр. Поддерживаются форматы типа 89061234567, 79061234567, 9061234567 — приведение к +79061234567. Валидация в запросах: pattern `^\+7\d{10}$`.

---

## 15. Разбор ответов API

Ниже перечислены все типы ответов API с полным описанием полей: тип, возможные значения и смысл поля. Где ответ — массив, описан один элемент массива.

### 15.1. Health

**GET `/api/v1/health`** — тело ответа 200.

| Поле     | Тип    | Значения | Описание |
|----------|--------|----------|----------|
| `status` | string | `"ok"`   | Сервис доступен. |

---

### 15.2. Auth

**POST `/api/v1/auth/login`** — тело ответа 200 (TokenResponse).

| Поле           | Тип    | Значения        | Описание |
|----------------|--------|-----------------|----------|
| `access_token` | string | JWT             | Токен для заголовка `Authorization: Bearer <token>`. |
| `token_type`   | string | `"bearer"`      | Тип токена. |
| `role`         | string | `"ADMIN"`, `"CLIENT"` | Роль пользователя. |

**POST `/api/v1/auth/register`** — тело ответа 201 (UserPublic, см. п. 15.3).

---

### 15.3. UserPublic

Используется в: GET/PUT `/api/v1/profile`, POST `/api/v1/auth/register`, GET `/api/v1/admin/users`, POST block/unblock.

| Поле         | Тип    | Значения / формат | Описание |
|--------------|--------|-------------------|----------|
| `id`         | number | целое             | Идентификатор пользователя. |
| `login`      | string | 6–20 символов     | Уникальный логин. |
| `email`      | string | email или null    | Email (уникальный в системе). В ответе может быть пустая строка при null. |
| `role`       | string | `"CLIENT"`, `"ADMIN"` | Роль. |
| `status`     | string | `"ACTIVE"`, `"BLOCKED"` | Статус: активен или заблокирован. |
| `first_name` | string | до 100 символов или `""` | Имя. При отсутствии в ответе пустая строка. |
| `last_name`  | string | до 100 символов или `""` | Фамилия. При отсутствии — пустая строка. |
| `phone`      | string | `+7XXXXXXXXXX` или null | Телефон в нормализованном виде. |

---

### 15.4. AccountPublic

Используется в: GET `/api/v1/accounts`, POST создание счёта, DELETE закрытие, POST topup (не используется; при topup возвращается транзакция), Helper increase/decrease/zero.

| Поле             | Тип    | Значения / формат | Описание |
|------------------|--------|-------------------|----------|
| `id`             | number | целое             | Идентификатор счёта. |
| `account_number` | string | 16 цифр           | Номер счёта (префикс по валюте: 2202 RUB, 3202 USD, 4202 EUR, 5202 CNY). |
| `account_type`   | string | `"DEBIT"`, `"SAVINGS"` | Тип: расчётный (переводы/платежи) или накопительный (только пополнение). |
| `currency`       | string | `"RUB"`, `"USD"`, `"EUR"`, `"CNY"` | Валюта счёта. |
| `balance`        | string | число с 2 знаками после запятой | Текущий баланс (например `"1000.50"`). |
| `is_primary`     | boolean| true / false      | Приоритетный счёт для зачисления переводов по данной валюте. |

---

### 15.5. TransactionPublic и вложенный объект money

Используется в: GET `/api/v1/transactions`, POST переводы, POST платежи, POST пополнение счёта, GET `/api/v1/admin/users/{id}/transactions`.

| Поле               | Тип    | Значения / формат | Описание |
|--------------------|--------|-------------------|----------|
| `id`               | number | целое             | Идентификатор операции. Используется для запроса чека: GET `/api/v1/transactions/{id}/receipt`. |
| `type`             | string | `"TOPUP"`, `"TRANSFER"`, `"PAYMENT"` | Тип операции: пополнение, перевод, платёж. |
| `money`            | object | см. таблицу ниже  | Суммы и валюта. |
| `money.amount`     | string | число с 2 знаками | Сумма операции без комиссии (например `"1500.00"`). |
| `money.fee`        | string | число с 2 знаками | Комиссия; при отсутствии `"0.00"`. У переводов во внешний банк — 5% или 2%. |
| `money.total`      | string | число с 2 знаками | Итого: amount + fee (фактически списано или зачислено). |
| `money.currency`   | string | `"RUB"`, `"USD"`, `"EUR"`, `"CNY"` | Валюта операции. |
| `description`      | string | или null          | Описание (например `p2p_transfer`, `external_transfer:RUB:••••1234:fee_50.00`, `mobile:MTSha:+79061234567`). |
| `created_at`       | string | datetime ISO      | Дата и время операции (например `"2026-02-26T12:34:56.000000"`). |
| `from_account_id`  | number | или null          | ID счёта списания. null у пополнения (TOPUP). |
| `to_account_id`   | number | или null          | ID счёта зачисления. null у платежа или перевода во внешний банк. |
| `status`           | string | `"COMPLETED"`, `"FAILED"` | Статус операции. |

---

### 15.6. ActionResponse

Используется в: PUT `/api/v1/accounts/primary`, DELETE `/api/v1/accounts/{id}`.

| Поле     | Тип    | Значения | Описание |
|----------|--------|----------|----------|
| `status` | string | `"ok"`   | Результат успешен. |
| `detail` | string | опционально | Код/сообщение (например `"account_closed"`, `"primary_accounts_updated"`). |

---

### 15.7. Проверка счёта и телефона (переводы)

**GET `/api/v1/transfers/by-account/check`** — тело ответа 200.

| Поле    | Тип    | Значения | Описание |
|---------|--------|----------|----------|
| `found` | boolean| true / false | Счёт с таким номером есть в нашем банке. |
| `masked`| string | например `"••••1234"` | Маска номера для отображения (последние 4 цифры). |

**GET `/api/v1/transfers/by-phone/check`** — тело ответа 200.

| Поле             | Тип   | Значения | Описание |
|------------------|-------|----------|----------|
| `inOurBank`      | boolean | true / false | Получатель с таким телефоном есть в нашем банке. |
| `availableBanks` | array | массив объектов | Список банков для выбора при переводе. |
| `availableBanks[].id`   | string | код банка (например `"shlapabank"`, `"alpha"`) | Код для поля `recipient_bank_id` в запросе перевода. |
| `availableBanks[].label`| string | название (например `"ShlapaBank"`) | Название для отображения. Если inOurBank=true — первый элемент наш банк, далее до 5 банков получателя; иначе — все внешние банки из справочника. |

---

### 15.8. Суточный лимит и курсы (переводы)

**GET `/api/v1/transfers/daily-usage`** — тело ответа 200.

| Поле | Тип  | Описание |
|------|------|----------|
| `limits` | object | Объект с вложенной структурой. |
| `limits.perCurrency` | array | Массив по валютам (RUB, USD, EUR, CNY). |
| `limits.perCurrency[].currency` | string | Код валюты. |
| `limits.perCurrency[].dailyLimit` | string | Суточный лимит в единицах валюты (например `"1000000.00"`). |
| `limits.perCurrency[].usedToday` | string | Уже использовано за сегодня. |
| `limits.perCurrency[].remaining`  | string | Остаток (dailyLimit − usedToday). |

**GET `/api/v1/transfers/rates`** — тело ответа 200.

| Поле    | Тип   | Описание |
|---------|-------|----------|
| `userId`| number| ID текущего пользователя. |
| `base`  | string| `"RUB"` — базовая валюта курсов. |
| `toRub` | object| Курсы к рублю: ключ — код валюты (RUB, USD, EUR, CNY), значение — строка числа (например `"95"` для USD). |

---

### 15.9. Платежи — справочники

**GET `/api/v1/payments/mobile/operators`** — тело ответа 200.

| Поле              | Тип   | Описание |
|-------------------|-------|----------|
| `userId`          | number| ID текущего пользователя. |
| `operators`       | array | Массив строк — коды операторов (например `"MTSha"`, `"Babline"`). Эти значения передавать в поле `operator` при оплате. |
| `amountRangeRub`  | object| Диапазон суммы в рублях. |
| `amountRangeRub.min` | number | Минимум (100). |
| `amountRangeRub.max` | number | Максимум (12000). |

**GET `/api/v1/payments/vendor/providers`** — тело ответа 200.

| Поле              | Тип   | Описание |
|-------------------|-------|----------|
| `userId`          | number| ID текущего пользователя. |
| `providers`       | array | Массив объектов поставщиков. |
| `providers[].name`| string| Название поставщика (передавать в поле `provider` при оплате). |
| `providers[].accountLength` | number | Строгое количество цифр в лицевом счёте для этого поставщика. |
| `amountRangeRub`  | object| `min` (100), `max` (500000). |

---

### 15.10. Helper

**GET `/api/v1/helper/otp/preview`** — тело ответа 200.

| Поле       | Тип    | Описание |
|------------|--------|----------|
| `userId`   | number | ID пользователя. |
| `otp`      | string | Код из 4 цифр (одноразовый, действует 1 минуту). |
| `ttlSeconds` | number | Срок жизни кода в секундах (60). |
| `message`  | string | Текст для отображения (например «SMS: ваш код …»). |

**GET `/api/v1/helper/accounts`** — тело ответа 200.

Для клиента: массив объектов в формате **AccountPublic** (см. п. 15.4).  
Для админа: массив объектов с полями **AccountPublic** плюс одно дополнительное поле:

| Поле          | Тип   | Описание |
|---------------|-------|----------|
| `owner_login` | string| Логин владельца счёта (только в ответе для админа). |

---

### 15.11. Admin — прочие ответы

**DELETE `/api/v1/admin/users/{user_id}`** — тело ответа 200.

| Поле     | Тип   | Значения | Описание |
|----------|-------|----------|----------|
| `detail` | string| `"user_deleted"` | Пользователь удалён. |

**POST `/api/v1/admin/restore-initial-state`** — тело ответа 200.

| Поле     | Тип   | Описание |
|----------|-------|----------|
| `detail` | string| `"database_reset"`. |
| `message`| string| Текстовое сообщение (например о том, что остался только дефолтный админ). |

**GET `/api/v1/admin/users/{user_id}/banks`** — тело ответа 200.

| Поле         | Тип   | Описание |
|--------------|-------|----------|
| `bank_codes` | array | Массив строк — коды банков пользователя (внешние, до 5). |

**PUT `/api/v1/admin/users/{user_id}/banks`** — тело ответа 200.

| Поле         | Тип   | Описание |
|--------------|-------|----------|
| `detail`     | string| `"banks_updated"`. |
| `bank_codes` | array | Обновлённый список кодов банков. |

---

### 15.12. Settings

**GET `/api/v1/settings`** — тело ответа 200.

| Поле                 | Тип    | Значения | Описание |
|----------------------|--------|----------|----------|
| `theme`              | string | `"LIGHT"` | Тема интерфейса. |
| `language`           | string | `"RU"`    | Язык. |
| `notificationsEnabled` | boolean | true / false | Включены ли уведомления. |

---

### 15.13. Ошибки (общее тело ответа)

При ошибке (4xx, 5xx) в теле обычно передаётся JSON с полем `detail`:

- `detail` — строка (код ошибки, см. таблицы по разделам в ТС) или массив объектов валидации (при 422).  
- В разделе 1.3 и в таблицах «Реализуемые API» по каждой ручке перечислены все возможные значения `detail` и соответствующие HTTP-коды.

---

Конец документа.
